define(["jquery","ccRestClient","knockout","CCi18n","ccConstants","notifier","pubsub","bstypeahead"],function(e,t,n,r,i,s,o){"use strict";return{elementName:"ultrasource-product-search-v1",productSearchValue:n.observable(),showAddByButton:n.observable(!1),showProductSearchInputBox:n.observable(!0),showRemoveTextboxButton:n.observable(!1),catalogId:"",typeAheadMinimumNumberOfCharacters:n.observable("3"),MAX_RESULTS:100,NO_MATCHES_FOUND:"No matches found",onLoad:function(t){var n=this;n.resetValues(),typeof t.productSearchSuccessCallback=="function"&&(n.widgetSuccessCallback=t.productSearchSuccessCallback.bind(t)),typeof t.productSearchFailureCallback=="function"&&(n.widgetFailureCallback=t.productSearchFailureCallback.bind(t)),t.showAddByButton&&t.showAddByButton()&&(n.showAddByButton(!0),n.showProductSearchInputBox(!1),n.showRemoveTextboxButton(!0),e.Topic(o.topicNames.CART_ADD_SUCCESS).subscribe(n.handlePostAddItem.bind(n,t))),(t.cart().currentOrderState()=="PENDING_PAYMENT"||t.cart().currentOrderState()=="PENDING_PAYMENT_TEMPLATE")&&n.hideAddByProductButton(),t.typeAheadMinimumNumberOfCharacters&&t.typeAheadMinimumNumberOfCharacters()&&n.typeAheadMinimumNumberOfCharacters(t.typeAheadMinimumNumberOfCharacters()),n.catalogId=t.user().catalogId()},resetSearch:function(){var e=this;this.productSearchValue(null)},resetValues:function(){var e=this;e.productSearchValue(""),e.showAddByButton(!1),e.showProductSearchInputBox(!0),e.showRemoveTextboxButton(!1),e.catalogId=""},initializer:function(t,n,r){var i=this.elements["ultrasource-product-search-v1"];r&&(n.popupId=r);var s=".productSearchBox";e(s).typeahead({source:i.typeaheadSource,minLength:i.typeAheadMinimumNumberOfCharacters(),autoSelect:!0,items:i.MAX_RESULTS,matcher:i.typeaheadMatch,sorter:i.typeaheadSort,highlighter:i.typeaheadHighlight,data:{element:i,widget:n},render:i.typeaheadRender,select:i.typeaheadSelect,menu:"<ul class='typeahead dropdown-menu' aria-live='polite'></ul>",item:"<li class='typeaheadProduct'><a href='#'>                             <span class = 'typeaheadProductName' style='word-wrap:normal; width:100%;'> </span>  </a></li>"})},typeaheadSource:function(e,n){this.render=this.options.render||this.render,this.$menu.css("margin-left",0),this.$menu.css("width","100%");var r=this.options.data.element,o=this.options.data.widget,u=function(){r.callback=n,this.timer&&clearTimeout(this.timer);var e={name:this.query.replace(/\*/g,"%"),fields:"id,displayName",showInactiveProducts:!1};e[i.CATALOG]=o.user().catalogId(),t.request(i.ENDPOINT_PRODUCTS_LIST_PRODUCTS,e,function(e){e||(e=[],e.push({id:r.NO_MATCHES_FOUND,name:""})),this.callback(e)}.bind(r),function(e){e&&e.message&&(s.sendError(r.elementName,e.message,!0),typeof r.widgetFailureCallback=="function"&&r.widgetFailureCallback(e))}.bind(r))}.bind(this);this.timer=setTimeout(u,300)},typeaheadRender:function(t){var n=this,i=n.options.data.element;if(t.length===1&&t[0].id===i.NO_MATCHES_FOUND){var s=r.t("ns.common:resources.noMatchesFound");return this.$menu.html(e("<li class='typeaheadTop' disabled>").text(s)),this}return t=e(t).map(function(t,r){var i=e(n.options.item).attr("data-value",r.displayName);return i.find("a").attr("title",r.displayName),i.find("a").attr("id",r.id),i.find(".typeaheadProductName").html(r.displayName),i[0]}),t.first().addClass("active"),this.$menu.html(t),this},typeaheadMatch:function(e){return!0},typeaheadSort:function(e){return e},typeaheadHighlight:function(e){return e},typeaheadSelect:function(){var e=this.$menu.find(".active"),t=e.children("a").attr("title"),n=e.children("a").attr("id"),r=this.options.data.element;return r.productSearchValue(t),typeof r.widgetSuccessCallback=="function"&&r.widgetSuccessCallback(n),this.hide()},enableProductSearchInputBox:function(){var t=this;t.showProductSearchInputBox(!0),t.resetSearch(),e("#product-search-box").focus()},handlePostAddItem:function(e){var t=this;e.cart().getCartAvailability(),t.hideProductSearchInputBox()},hideProductSearchInputBox:function(){var e=this;e.showProductSearchInputBox(!1)},hideAddByProductButton:function(){var e=this;e.showProductSearchInputBox(!1),e.showAddByButton(!1)}}})