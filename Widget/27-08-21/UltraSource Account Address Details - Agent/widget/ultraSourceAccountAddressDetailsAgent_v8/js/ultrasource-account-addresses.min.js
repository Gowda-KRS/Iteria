define(["ccConstants","knockout","navigation","notifier","spinner","ccRestClient","ccStoreConfiguration","CCi18n","jquery","viewModels/dynamicPropertyMetaContainer","pubsub"],function(e,t,n,r,i,s,o,u,a,f,l){"use strict";return{WIDGET_ID:"accountAddresses",addresses:t.observableArray([]),allAddresses:t.observableArray([]),inheritedAddresses:t.observableArray([]),secondaryAddresses:t.observableArray([]),profileAddresses:t.observableArray([]),showInherited:t.observable(!1),showProfileAddress:t.observable(!1),hasSecondaryAddresses:t.observable(!1),isEditMode:t.observable(!1),totalInheritedAddresses:t.observable(0),totalProfileAddresses:t.observable(0),totalAccountAddresses:t.observable(0),showLoadMore:t.observable(!1),showLoadMorePAddress:t.observable(!1),showLoadMoreAccountAddress:t.observable(!1),companyName:t.observable(),addressType:t.observable(),firstName:t.observable(),lastName:t.observable(),address1:t.observable(),address2:t.observable(),address3:t.observable(),county:t.observable(),city:t.observable(),country:t.observable(),state:t.observable(),postalCode:t.observable(),phoneNumber:t.observable(),isDefaultShippingAddress:t.observable(!1),isDefaultBillingAddress:t.observable(!1),defaultShippingAddress:t.observableArray(),defaultBillingAddress:t.observableArray(),countriesList:t.observableArray(),stateList:t.observableArray([]),subscriptionArray:[],isDirty:t.observable(!1),isCreateNewAddress:t.observable(!1),isProfileAddress:t.observable(!1),editingAddressId:t.observable(),duplicateEditingAddressId:t.observable(),offset:t.observable(0),profileOffset:t.observable(0),accountOffset:t.observable(0),limit:t.observable(40),defaultBillingAddressType:t.observable(),defaultShippingAddressType:t.observable(),isGettingSavedToProfile:t.observable(!1),isGettingSavedToAccount:t.observable(!1),deleteButtonId:null,addressToBeDeleted:null,postalCodePattern:t.observable(""),US_POSTAL_CODE_PATTERN:"^[0-9]{5}([ -][0-9]{4})?$",CANADA_POSTAL_CODE_PATTERN:"^[abceghjklmnprstvxyABCEGHJKLMNPRSTVXY]{1}[0-9]{1}[a-zA-Z]{1} *[0-9]{1}[a-zA-Z]{1}[0-9]{1}$",DEFAULT_POSTAL_CODE_PATTERN:"^[0-9a-zA-Z]{1,}([ -][0-9a-zA-Z]{1,})?$",addressObject:t.validatedObservable(),dynamicPropertyMetaInfo:f.getInstance(),dynamicProperties:t.observableArray([]),opDynamicProperty:t.observable(),subscriptions:[],operationPerformedOnAddresses:t.observable(),contextManager:null,siteFilter:t.observable(null),organizationFilter:t.observable(null),homeRoute:"",onLoad:function(n){s.profileType!==e.PROFILE_TYPE_AGENT&&(n.spinnerOptions={parent:"#CC-scheduledOrder-scheduleForm",posTop:"0",posLeft:"50%"}),n.country.extend({required:{params:!0,message:n.translate("countryRequiredText")}}),n.addressType.extend({required:{params:!0,onlyIf:function(){return s.profileType===e.PROFILE_TYPE_AGENT?n.user().isProfileAddressManager()||n.user().isAccountAddressManager()||n.user().isDelegatedAdmin()||n.isGettingSavedToProfile()||!n.user().isB2BUser():!n.user().isProfileAddressManager()&&(n.user().isAccountAddressManager()||n.user().isDelegatedAdmin())||n.isGettingSavedToAccount()},message:n.translate("nickNameRequiredText")},maxLength:{params:e.ACCOUNT_NICKNAME_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:e.ACCOUNT_NICKNAME_MAXIMUM_LENGTH})}}),n.firstName.extend({required:{params:!0,onlyIf:function(){return n.user().isProfileAddressManager()&&!n.user().isAccountAddressManager()&&!n.user().isDelegatedAdmin()||n.isGettingSavedToProfile()||!n.user().isB2BUser()},message:n.translate("firstNameRequired")},maxLength:{params:o.ADDRESS_FIRSTNAME_MAXIMUM_LENGTH?o.ADDRESS_FIRSTNAME_MAXIMUM_LENGTH:e.CYBERSOURCE_FIRSTNAME_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:o.ADDRESS_FIRSTNAME_MAXIMUM_LENGTH?o.ADDRESS_FIRSTNAME_MAXIMUM_LENGTH:e.CYBERSOURCE_FIRSTNAME_MAXIMUM_LENGTH})}}),n.lastName.extend({required:{params:!0,onlyIf:function(){return n.user().isProfileAddressManager()&&!n.user().isAccountAddressManager()&&!n.user().isDelegatedAdmin()||n.isGettingSavedToProfile()||!n.user().isB2BUser()},message:n.translate("lastNameRequired")},maxLength:{params:o.ADDRESS_LASTNAME_MAXIMUM_LENGTH?o.ADDRESS_LASTNAME_MAXIMUM_LENGTH:e.CYBERSOURCE_LASTNAME_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:o.ADDRESS_LASTNAME_MAXIMUM_LENGTH?o.ADDRESS_LASTNAME_MAXIMUM_LENGTH:e.CYBERSOURCE_LASTNAME_MAXIMUM_LENGTH})}}),n.companyName.extend({required:{params:!0,onlyIf:function(){return!n.user().isProfileAddressManager()&&(n.user().isAccountAddressManager()||n.user().isDelegatedAdmin())||n.isGettingSavedToAccount()},message:n.translate("companyNameRequiredText")}}),n.state.extend({required:{params:!0,onlyIf:function(){return n.stateList().length>0},message:n.translate("stateRequiredText")}}),n.address1.extend({required:{params:!0,message:n.translate("addressRequiredText")},maxLength:{params:o.ADDRESS_ADDRESS1_MAXIMUM_LENGTH?o.ADDRESS_ADDRESS1_MAXIMUM_LENGTH:e.CYBERSOURCE_ADDRESS_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:o.ADDRESS_ADDRESS1_MAXIMUM_LENGTH?o.ADDRESS_ADDRESS1_MAXIMUM_LENGTH:e.CYBERSOURCE_ADDRESS_MAXIMUM_LENGTH})}}),n.address2.extend({required:!1,maxLength:{params:o.ADDRESS_ADDRESS2_MAXIMUM_LENGTH?o.ADDRESS_ADDRESS2_MAXIMUM_LENGTH:e.CYBERSOURCE_ADDRESS_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:o.ADDRESS_ADDRESS2_MAXIMUM_LENGTH?o.ADDRESS_ADDRESS2_MAXIMUM_LENGTH:e.CYBERSOURCE_ADDRESS_MAXIMUM_LENGTH})}}),n.address3.extend({required:!1,maxLength:{params:o.ADDRESS_ADDRESS3_MAXIMUM_LENGTH?o.ADDRESS_ADDRESS3_MAXIMUM_LENGTH:e.CYBERSOURCE_ADDRESS_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:o.ADDRESS_ADDRESS3_MAXIMUM_LENGTH?o.ADDRESS_ADDRESS3_MAXIMUM_LENGTH:e.CYBERSOURCE_ADDRESS_MAXIMUM_LENGTH})}}),n.county.extend({required:!1,maxLength:{params:o.ADDRESS_COUNTY_MAXIMUM_LENGTH?o.ADDRESS_COUNTY_MAXIMUM_LENGTH:e.CYBERSOURCE_COUNTY_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:o.ADDRESS_COUNTY_MAXIMUM_LENGTH?o.ADDRESS_COUNTY_MAXIMUM_LENGTH:e.CYBERSOURCE_COUNTY_MAXIMUM_LENGTH})}}),n.city.extend({required:{params:!0,message:n.translate("cityRequiredText")},maxLength:{params:o.ADDRESS_CITY_MAXIMUM_LENGTH?o.ADDRESS_CITY_MAXIMUM_LENGTH:e.CYBERSOURCE_CITY_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{maxLength:o.ADDRESS_CITY_MAXIMUM_LENGTH?o.ADDRESS_CITY_MAXIMUM_LENGTH:e.CYBERSOURCE_CITY_MAXIMUM_LENGTH})}}),n.postalCode.extend({required:{params:!0,message:n.translate("postalCodeRequiredText")},maxLength:{params:e.CYBERSOURCE_POSTAL_CODE_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{fieldName:n.translate("postalCodeNameText"),maxLength:e.CYBERSOURCE_POSTAL_CODE_MAXIMUM_LENGTH})},observablePattern:{params:n.postalCodePattern,onlyIf:function(){return n.postalCodePattern()!=""},message:n.translate("postalCodeInvalid")}}),n.phoneNumber.extend({required:{params:!0,onlyIf:function(){return!n.user().isB2BUser()||!n.user().isProfileAddressManager()&&(n.user().isAccountAddressManager()||n.user().isDelegatedAdmin())||n.isGettingSavedToAccount()},message:n.translate("phoneNumberRequiredText")},pattern:{params:"^[0-9()+ -]+$",message:n.translate("invalidPhoneNumber")},maxLength:{params:e.CYBERSOURCE_PHONE_NUMBER_MAXIMUM_LENGTH,message:n.translate("maxlengthValidationMsg",{fieldName:n.translate("phoneNumberText"),maxLength:e.CYBERSOURCE_PHONE_NUMBER_MAXIMUM_LENGTH})}}),n.validationModel=t.validatedObservable({country:n.country,state:n.state,address1:n.address1,address2:n.address2,address3:n.address3,county:n.county,city:n.city,postalCode:n.postalCode,phoneNumber:n.phoneNumber,addressType:n.addressType,companyName:n.companyName,lastName:n.lastName,firstName:n.firstName}),n.countriesList(n.shippingCountries()),n.homeRoute=n.links().home.route,s.profileType===e.PROFILE_TYPE_AGENT&&(n.homeRoute=n.links().agentHome.route,n.contextManager=require("agentViewModels/agent-context-manager").getInstance(),a.Topic(l.topicNames.PAGE_CHANGED).subscribe(n.triggerPageChangeEvent.bind(n)))},initializeDynamicProperties:function(t,n,r){var i=this;i.dynamicProperties.removeAll();var s=i.dynamicPropertyMetaInfo.createDynamicProperties(t,e.ADDRESS_TEXT);if(!r){var o=[];for(var u=0,a=0;u<s.length;u++)n.address&&n.address.hasOwnProperty(t[u].id())&&(o[a]=s[u],a++);i.dynamicProperties(o)}else i.dynamicProperties(s)},assignValueToDynamicProperties:function(e,t,n){var r=this;for(var i=0;i<r.dynamicProperties().length;i++)r.dynamicProperties()[i].id()===e&&(n?r.dynamicProperties()[i].values.push(t):r.dynamicProperties()[i].value(t))},clearDynamicProperties:function(){var e=this;for(var t=0;t<e.dynamicProperties.length;t++)e.dynamicProperties[t].value(null),e.dynamicProperties[t].values.removeAll()},populateDynamicPropertiesMetaData:function(){var t=this,n={};n[e.PARENT]=e.ENDPOINT_CONTACT_INFO_TYPE,t.dynamicPropertyMetaInfo&&t.dynamicPropertyMetaInfo.dynamicPropertyMetaCache&&!t.dynamicPropertyMetaInfo.dynamicPropertyMetaCache.hasOwnProperty(e.ENDPOINT_CONTACT_INFO_TYPE)&&s.request(e.ENDPOINT_GET_ITEM_TYPE,n,function(n){t.dynamicPropertyMetaInfo.intializeDynamicProperties(n.specifications,e.ENDPOINT_CONTACT_INFO_TYPE)},function(e){},e.ENDPOINT_CONTACT_INFO_TYPE)},loadProfileAddresses:function(){var t=this,n=e.END_POINT_LIST_PROFILE_ADDRESSES,r={};r[e.OFFSET]=t.profileOffset(),r[e.LIMIT]=t.limit(),s.profileType===e.PROFILE_TYPE_AGENT?s.request(n,r,t.loadProfileAddressSuccess.bind(t),t.fetchAddressesFailure.bind(t),t.user().id()):s.request(n,r,t.loadProfileAddressSuccess.bind(t),t.fetchAddressesFailure.bind(t))},loadDefaultAddressesSuccess:function(e){var t=this;if(e.address){t.addresses.removeAll();var n=t.fetchCountryandStateName(e.address.country,e.address.state);e.address.displayCountryName=n.country,e.address.displayStateName=n.state?n.state:" ",e.address.addressType=e.addressType,t.defaultShippingAddress(e.address),t.user().contactShippingAddress=e.address,t.defaultShippingAddressType(e.addressType),t.setDefaultAdresses(),e.address.isDefaultShippingAddress=!0,t.addresses().push(e),t.addresses.valueHasMutated()}},loadProfileAddressSuccess:function(t){var n=this;if(t.items.length>0){t.items=t.items.sort(function(e,t){return e.address.lastName&&t.address.lastName&&e.address.lastName.toLowerCase()==t.address.lastName.toLowerCase()?e.address.address1.toLowerCase()==t.address.address1.toLowerCase()?0:e.address.address1.toLowerCase()<t.address.address1.toLowerCase()?-1:1:e.address.lastName&&t.address.lastName&&e.address.lastName.toLowerCase()<t.address.lastName.toLowerCase()?-1:1}),n.showProfileAddress(!0);for(var r=0;r<t.items.length;r++){t.items[r].isProfile=!0;var i=n.fetchCountryandStateName(t.items[r].address.country,t.items[r].address.state);t.items[r].address.displayCountryName=i.country,t.items[r].address.displayStateName=i.state?i.state:" ",n.profileAddresses().push(t.items[r])}n.profileOffset(t.offset+t.items.length),n.allAddresses.push(t.items),n.profileAddresses.valueHasMutated(),n.totalProfileAddresses(t.total),n.totalProfileAddresses()>n.profileOffset()?n.showLoadMorePAddress(!0):(n.showLoadMorePAddress(!1),n.profileOffset(0))}if(s.profileType===e.PROFILE_TYPE_AGENT&&!n.user().isB2BUser()){var o=null;n.user().contactShippingAddress?o=n.user().contactShippingAddress.repositoryId:n.user().contactBillingAddress?o=n.user().contactBillingAddress.repositoryId:t.items.length>0&&!o&&(n.setDefaultShippingAddress(t.items[0]),n.loadDefaultAddressesSuccess(t.items[0]));if(o){var t={},u=e.END_POINT_GET_PROFILE_ADDRESS;s.request(u,t,n.loadDefaultAddressesSuccess.bind(n),n.fetchAddressesFailure.bind(n),n.user().id(),o)}}},loadInheritedAddresses:function(){var t=this;t.showInherited(!1);var n=e.END_POINT_LIST_ADDRESSES,r={};r.orgId=s.profileType===e.PROFILE_TYPE_AGENT?t.organizationFilter():t.user().currentOrganization().repositoryId,r.include=e.END_POINT_INHERITED_ADDRESSES,r.offset=t.offset(),r.limit=t.limit(),s.request(n,r,t.loadInheritedAddressSuccess.bind(t),t.fetchAddressesFailure.bind(t))},loadInheritedAddressSuccess:function(e){var t=this;e.derivedShippingAddressType&&t.defaultShippingAddressType(e.derivedShippingAddressType),e.derivedBillingAddressType&&t.defaultBillingAddressType(e.derivedBillingAddressType);if(e.items.length>0){t.showInherited(!0);for(var n=0;n<e.items.length;n++){e.items[n].isInherited=!0;var r=t.fetchCountryandStateName(e.items[n].address.country,e.items[n].address.state);e.items[n].address.displayCountryName=r.country,e.items[n].address.displayStateName=r.state?r.state:" ",t.inheritedAddresses().push(e.items[n])}t.offset(e.offset+e.items.length),t.allAddresses.push(e.items),t.inheritedAddresses.valueHasMutated(),t.totalInheritedAddresses(e.total),t.totalInheritedAddresses()>t.offset()?t.showLoadMore(!0):(t.showLoadMore(!1),t.offset(0))}},loadAddresses:function(){var t=this;t.opDynamicProperty("view"),t.allAddresses.removeAll(),t.inheritedAddresses.removeAll(),t.profileAddresses.removeAll(),t.addresses.removeAll(),t.offset(0),t.secondaryAddresses.removeAll(),t.profileOffset(0),t.accountOffset(0);if(s.profileType===e.PROFILE_TYPE_AGENT){if(!t.user().isB2BUser()||t.organizationFilter()!==null)t.loadProfileAddresses(),t.user().isB2BUser()&&(t.loadInheritedAddresses(),t.loadOrganizationAddresses())}else t.loadProfileAddresses(),t.loadInheritedAddresses(),t.loadOrganizationAddresses()},loadOrganizationAddresses:function(){var t=this,n,r={},i=e.END_POINT_GET_ADDRESSES,o=e.END_POINT_LIST_ADDRESSES,u=s.profileType===e.PROFILE_TYPE_AGENT?t.organizationFilter():t.user().currentOrganization().repositoryId;r.orgId=u,r[e.OFFSET]=t.accountOffset(),r[e.LIMIT]=t.limit();var a=0;s.request(i,r,t.fetchAddressesSuccess.bind(t),t.fetchAddressesFailure.bind(t)),s.request(o,r,t.loadOrganizationAddressesSuccess.bind(t),t.fetchAddressesFailure.bind(t))},loadOrganizationAddressesSuccess:function(t){var n=this;t.derivedShippingAddressType&&n.defaultShippingAddressType(t.derivedShippingAddressType),t.derivedBillingAddressType&&n.defaultBillingAddressType(t.derivedBillingAddressType);if(s.profileType!==e.PROFILE_TYPE_AGENT){for(var r=0;r<t.items.length;r++)t.items[r].isInherited=!1;n.allAddresses.push(t.items),n.secondaryAddresses(n.secondaryAddresses().concat(t.items))}else if(n.secondaryAddresses().length===0&&t.items.length>0){for(var r=0;r<t.items.length;r++){t.items[r].isInherited=!1;var i=n.fetchCountryandStateName(t.items[r].address.country,t.items[r].address.state);t.items[r].address.displayCountryName=i.country,t.items[r].address.displayStateName=i.state?i.state:" "}n.allAddresses.push(t.items),n.secondaryAddresses(n.secondaryAddresses().concat(t.items))}n.accountOffset(t.offset+t.items.length),n.totalAccountAddresses(t.total),n.totalAccountAddresses()>n.accountOffset()?n.showLoadMoreAccountAddress(!0):(n.showLoadMoreAccountAddress(!1),n.accountOffset(0))},fetchAddressesSuccess:function(t){var n=this,r=null;n.user().isB2BUser()&&t.billingAddress?(r=n.fetchCountryandStateName(t.billingAddress.country,t.billingAddress.state),t.billingAddress.displayCountryName=r.country,t.billingAddress.displayStateName=r.state?r.state:" ",n.defaultBillingAddress(t.billingAddress)):n.defaultBillingAddress(null);if(s.profileType===e.PROFILE_TYPE_AGENT&&t.secondaryAddresses.length>0){for(var i=0;i<t.secondaryAddresses.length;i++){t.secondaryAddresses[i].isInherited=!1;var r=n.fetchCountryandStateName(t.secondaryAddresses[i].address.country,t.secondaryAddresses[i].address.state);t.secondaryAddresses[i].address.displayCountryName=r.country,t.secondaryAddresses[i].address.displayStateName=r.state?r.state:" "}n.secondaryAddresses([]),n.secondaryAddresses(n.secondaryAddresses().concat(t.secondaryAddresses))}n.defaultBillingAddress()&&n.defaultBillingAddress().repositoryId&&s.request(e.END_POINT_GET_ADDRESS,null,function(e){var t=n.fetchCountryandStateName(e.address.country,e.address.state);e.address.displayCountryName=t.country,e.address.displayStateName=t.state?t.state:" ",e.address.isInherited?e.isInherited=!0:e.isInherited=!1,n.addresses().length<2&&(e.address.isDefaultBillingAddress=!0,n.addresses.push(e),n.addresses.valueHasMutated(),n.checkSameDefaultAddress())},function(){},n.defaultBillingAddress().repositoryId);if(n.user().isB2BUser()&&t.shippingAddress){var r=n.fetchCountryandStateName(t.shippingAddress.country,t.shippingAddress.state);t.shippingAddress.displayCountryName=r.country,t.shippingAddress.displayStateName=r.state?r.state:" ",n.defaultShippingAddress(t.shippingAddress)}else n.defaultShippingAddress(null);n.defaultShippingAddress()&&n.defaultShippingAddress().repositoryId&&s.request(e.END_POINT_GET_ADDRESS,null,function(e){var t=n.fetchCountryandStateName(e.address.country,e.address.state);e.address.displayCountryName=t.country,e.address.displayStateName=t.state?t.state:" ",e.address.isInherited?e.isInherited=!0:e.isInherited=!1,n.addresses().length<2&&(e.address.isDefaultShippingAddress=!0,n.user().primaryShippingAddress(e.address),n.addresses.push(e),n.addresses.valueHasMutated(),n.checkSameDefaultAddress())},function(){},n.defaultShippingAddress().repositoryId),n.replaceAllAddress2NullStringWithNull(t.secondaryAddresses),n.setDefaultAdresses()},checkSameDefaultAddress:function(){var e=this;e.addresses().length===2&&e.addresses()[0].address.repositoryId===e.addresses()[1].address.repositoryId&&e.addresses.pop()},fetchAddressesFailure:function(t){var i=this;r.clearError(i.WIDGET_ID),r.clearSuccess(i.WIDGET_ID),t.status==e.HTTP_UNAUTHORIZED_ERROR?(i.user().handleSessionExpired(),(n.isPathEqualTo(i.links().profile.route)||n.isPathEqualTo(i.links().accountAddresses.route))&&n.doLogin(n.getPath(),i.homeRoute)):r.sendError(i.WIDGET_ID,t.message,!0)},setDefaultAdresses:function(){var e=this,t={},n={},r=!1,i=!1;e.addresses.removeAll();if(!(e.defaultShippingAddress()instanceof Array)&&e.defaultShippingAddressType()&&e.defaultShippingAddress()){t.address=e.defaultShippingAddress(),t.addressType=e.defaultShippingAddressType();if(e.secondaryAddresses().length>0)for(var s=0;s<e.secondaryAddresses().length;s++)e.defaultShippingAddress()&&e.defaultShippingAddress().repositoryId===e.secondaryAddresses()[s].address.repositoryId&&(r=!0)}if(!(e.defaultBillingAddress()instanceof Array)&&e.defaultBillingAddressType()&&e.defaultBillingAddress()){n.address=e.defaultBillingAddress(),n.addressType=e.defaultBillingAddressType();if(e.secondaryAddresses().length>0)for(var s=0;s<e.secondaryAddresses().length;s++)e.defaultBillingAddress()&&e.defaultBillingAddress().repositoryId===e.secondaryAddresses()[s].address.repositoryId&&(i=!0)}},handleCreateOrEditOrganizationAddress:function(t,n){var r=this;r.resetAddressData(),r.user().active()?r.opDynamicProperty("update"):r.opDynamicProperty("view"),r.subscribeForChanges();if(!t){r.isProfileAddress(n.isProfile),r.addressType(n.addressType),r.address1(n.address.address1),r.address2(n.address.address2),r.address3(n.address.address3),r.county(n.address.county),r.city(n.address.city),r.country(n.address.country),r.user().isB2BUser()&&r.companyName(n.address.companyName),r.state(n.address.state),r.postalCode(n.address.postalCode),r.phoneNumber(n.address.phoneNumber),r.firstName(n.address.firstName),r.lastName(n.address.lastName),r.isDefaultShippingAddress(n.address.isDefaultShippingAddress),r.defaultBillingAddress()!==null&&n.address.repositoryId===r.defaultBillingAddress().repositoryId&&r.isDefaultBillingAddress(!0),r.defaultShippingAddress()!==null&&n.address.repositoryId===r.defaultShippingAddress().repositoryId&&r.isDefaultShippingAddress(!0),r.editingAddressId(n.address.repositoryId),r.isCreateNewAddress(!1);if(s.profileType===e.PROFILE_TYPE_AGENT){var i=r.dynamicPropertyMetaInfo.dynamicPropertyMetaCache[e.ENDPOINT_CONTACT_INFO_TYPE];if(i&&i.length>0){r.initializeDynamicProperties(i,n,t);var o=null;for(var u=0;u<i.length;u++)if(n.address[i[u].id()]&&n.address[i[u].id()]!==undefined)if(i[u].type()==="enum")for(var a=0;a<n.address[i[u].id()].length;a++)o=n.address[i[u].id()][a],r.dynamicPropertyMetaInfo.dynamicPropertyMetaCache[e.ENDPOINT_CONTACT_INFO_TYPE][u].values.push(o),r.assignValueToDynamicProperties(i[u].id(),o,!0);else o=n.address[i[u].id()],r.assignValueToDynamicProperties(i[u].id(),o,!1),r.dynamicPropertyMetaInfo.dynamicPropertyMetaCache[e.ENDPOINT_CONTACT_INFO_TYPE][u].value(o)}}}else{if(s.profileType===e.PROFILE_TYPE_AGENT){var i=r.dynamicPropertyMetaInfo.dynamicPropertyMetaCache[e.ENDPOINT_CONTACT_INFO_TYPE];i&&i.length>0&&r.initializeDynamicProperties(i,n,t)}r.user().isProfileAddressManager()&&!r.user().isAccountAddressManager()&&!r.user().isDelegatedAdmin()&&r.isProfileAddress(!0),r.isCreateNewAddress(!0)}r.isEditMode(!0),r.isDirty(!1)},handleUpdateOrganizationAddress:function(e){var t=this;(t.isCreateNewAddress()&&e==="organization-address-save-create-new"||e==="organization-address-update"&&(t.isProfileAddress()||!t.user().isAccountAddressManager()&&!t.user().isDelegatedAdmin())||e==="organization-address-save-copy"||e==="profile-address-create")&&t.user().isProfileAddressManager()||e==="organization-address-save-create-new"&&t.isProfileAddress()&&t.user().isProfileAddressManager()&&!t.user().isAccountAddressManager()&&!t.user().isDelegatedAdmin()?(t.isGettingSavedToProfile(!0),t.isGettingSavedToAccount(!1)):t.user().isB2BUser()&&(t.isGettingSavedToAccount(!0),t.isGettingSavedToProfile(!1)),t.validationModel.isValid()?(t.isCreateNewAddress()&&e==="organization-address-save-create-new"||e==="organization-address-save-copy"||e==="account-address-create")&&(t.user().isAccountAddressManager()||t.user().isDelegatedAdmin())?t.createNewOrganizationAddress(t.convertToData()):(t.isCreateNewAddress()&&e==="organization-address-save-create-new"||e==="organization-address-save-copy"||e==="profile-address-create")&&t.user().isProfileAddressManager()?t.createNewProfileAddress(t.convertToData()):t.isCreateNewAddress()&&!t.user().isB2BUser()?t.createNewProfileAddress(t.convertToData()):e!=="organization-address-update"&&e!=="organization-address-save-create-new"||!t.isProfileAddress()?(e==="organization-address-update"||e==="organization-address-save-create-new")&&!t.isProfileAddress()&&(t.user().isB2BUser()?t.updateOrganizationAddress(t.convertToData(),t.editingAddressId()):t.updateProfileAddress(t.convertToData(),t.editingAddressId())):t.updateProfileAddress(t.convertToData(),t.editingAddressId()):t.validationModel.errors.showAllMessages()},updateOrganizationAddress:function(e,t){var n=this;n.updateAddress(e,t)},createNewOrganizationAddress:function(t){var n=this;n.operationPerformedOnAddresses("created"),s.request(e.END_POINT_ADD_ADDRESSES,t,n.createOrUpdateSuccess.bind(n),n.saveFailure.bind(n))},createNewProfileAddress:function(t){var n=this;n.operationPerformedOnAddresses("created"),s.profileType===e.PROFILE_TYPE_AGENT?s.request(e.END_POINT_ADD_PROFILE_ADDRESS,t,n.profileCreateOrUpdateSuccess.bind(n),n.profileAddressSaveFailure.bind(n),n.user().id()):s.request(e.END_POINT_ADD_PROFILE_ADDRESS,t,n.profileCreateOrUpdateSuccess.bind(n),n.profileAddressSaveFailure.bind(n))},updateAddress:function(t,n){var r=this;r.operationPerformedOnAddresses("updated"),s.request(e.END_POINT_UPDATE_ADDRESSES,t,r.createOrUpdateSuccess.bind(r),r.saveFailure.bind(r),n)},updateProfileAddress:function(t,n){var r=this;r.operationPerformedOnAddresses("updated"),s.profileType===e.PROFILE_TYPE_AGENT?s.request(e.END_POINT_UPDATE_PROFILE_ADDRESS,t,r.profileCreateOrUpdateSuccess.bind(r),r.profileAddressSaveFailure.bind(r),r.user().id(),n):s.request(e.END_POINT_UPDATE_PROFILE_ADDRESS,t,r.profileCreateOrUpdateSuccess.bind(r),r.profileAddressSaveFailure.bind(r),n)},profileCreateOrUpdateSuccess:function(t){var n=this;n.isDefaultShippingAddress()&&(n.user().contactShippingAddress=t.address,n.user().primaryShippingAddress(t.address)),n.isEditMode(!1),n.isGettingSavedToProfile(!1),n.isGettingSavedToAccount(!1),n.isProfileAddress(!1),r.clearError(n.WIDGET_ID),r.clearSuccess(n.WIDGET_ID),s.profileType===e.PROFILE_TYPE_AGENT?n.operationPerformedOnAddresses()==="created"?r.sendSuccess(n.WIDGET_ID,this.translate("agentProfileAddressCreateOperation"),!0):n.operationPerformedOnAddresses()==="updated"?r.sendSuccess(n.WIDGET_ID,this.translate("agentProfileAddressUpdateOperation"),!0):r.sendSuccess(n.WIDGET_ID,this.translate("agentProfileAddressDeleteOperation"),!0):r.sendSuccess(n.WIDGET_ID,this.translate("profileAddressUpdateSuccessText"),!0),n.operationPerformedOnAddresses(null),n.resetAddressData(),n.loadAddresses()},createOrUpdateSuccess:function(t){var n=this;n.isEditMode(!1),n.isGettingSavedToProfile(!1),n.isGettingSavedToAccount(!1),n.isProfileAddress(!1),r.clearError(n.WIDGET_ID),r.clearSuccess(n.WIDGET_ID),s.profileType===e.PROFILE_TYPE_AGENT?n.operationPerformedOnAddresses()==="created"?r.sendSuccess(n.WIDGET_ID,this.translate("agentOrganizationAddressCreateOperation"),!0):n.operationPerformedOnAddresses()==="updated"?r.sendSuccess(n.WIDGET_ID,this.translate("agentOrganizationAddressUpdateOperation"),!0):r.sendSuccess(n.WIDGET_ID,this.translate("agentOrganizationAddressDeleteOperation"),!0):r.sendSuccess(n.WIDGET_ID,this.translate("organizationAddressUpdateSuccessText"),!0),n.operationPerformedOnAddresses(null),n.resetAddressData(),n.loadAddresses()},profileAddressSaveFailure:function(t){var i=this;r.clearError(i.WIDGET_ID),r.clearSuccess(i.WIDGET_ID),t.status==e.HTTP_UNAUTHORIZED_ERROR?(i.user().handleSessionExpired(),(n.isPathEqualTo(i.links().profile.route)||n.isPathEqualTo(i.links().accountAddresses.route))&&n.doLogin(n.getPath(),i.homeRoute)):r.sendError(i.WIDGET_ID,t.message?t.message:this.translate("organizationAddressUpdateFailureText"),!0)},saveFailure:function(t){var i=this;r.clearError(i.WIDGET_ID),r.clearSuccess(i.WIDGET_ID),t.status==e.HTTP_UNAUTHORIZED_ERROR?(i.user().handleSessionExpired(),(n.isPathEqualTo(i.links().profile.route)||n.isPathEqualTo(i.links().accountAddresses.route))&&n.doLogin(n.getPath(),i.homeRoute)):r.sendError(i.WIDGET_ID,t.message?t.message:this.translate("organizationAddressUpdateFailureText"),!0)},setDefaultBillingAddress:function(t){var n=this,r={};n.defaultBillingAddress()&&n.defaultBillingAddress().repositoryId===t.address.repositoryId?(r[e.ORG_IS_DEFAULT_BILLING_ADDRESS]=!1,n.defaultBillingAddress(null)):r[e.ORG_IS_DEFAULT_BILLING_ADDRESS]=!0;var i={};i[e.ORG_ADDRESS]=r,i[e.ORG_ADDRESS_TYPE]=t.addressType,n.user().contactBillingAddress=t.address,n.updateAddress(i,t.address.repositoryId)},setDefaultShippingAddress:function(t){var n=this,r={};n.defaultShippingAddress()&&n.defaultShippingAddress().repositoryId===t.address.repositoryId?(r[e.ORG_IS_DEFAULT_SHIPPING_ADDRESS]=!1,n.defaultShippingAddress(null)):r[e.ORG_IS_DEFAULT_SHIPPING_ADDRESS]=!0;var i={};i[e.ORG_ADDRESS]=r,i[e.ORG_ADDRESS_TYPE]=t.addressType,n.user().contactShippingAddress=t.address,n.user().isB2BUser()?n.updateAddress(i,t.address.repositoryId):(n.isDefaultShippingAddress(!0),n.loadWidgetValues(t),n.updateProfileAddress(n.convertToData(),t.address.repositoryId))},loadWidgetValues:function(e){var t=this;t.addressType(e.addressType),t.address1(e.address.address1),t.address2(e.address.address2),t.address3(e.address.address3),t.county(e.address.county),t.country(e.address.country);for(var n=0;n<t.countriesList().length;n++)if(t.countriesList()[n].countryCode===t.country()){t.stateList(t.countriesList()[n].regions);break}t.state(e.address.state),t.firstName(e.address.firstName),t.lastName(e.address.lastName),t.companyName(e.address.companyName),t.city(e.address.city),t.postalCode(e.address.postalCode),t.phoneNumber(e.address.phoneNumber)},removeOrganizationAddress:function(t,n,r){var i=this;i.deleteButtonId=n,i.addressToBeDeleted=t,i.editingAddressId(t.repositoryId);if(s.profileType===e.PROFILE_TYPE_AGENT)a("#CC-accountAddress-delete-modal-1").modal("show"),a("body").addClass("modal-open");else{var o={};n.indexOf("CC-customerProfile-remove-addr-btn-")===0?s.request(e.END_POINT_DELETE_PROFILE_ADDRESS,o,i.profileCreateOrUpdateSuccess.bind(i),i.profileAddressSaveFailure.bind(i),i.editingAddressId()):n.indexOf("CC-account-remove-addr-btn")===0&&s.request(e.END_POINT_DELETE_ADDRESSES,o,i.createOrUpdateSuccess.bind(i),i.saveFailure.bind(i),i.editingAddressId())}},continueDeleteOperation:function(t,n,r){a("#CC-accountAddress-delete-modal-1").modal("hide"),setTimeout(function(){a("body").removeClass("modal-open"),a(".modal-backdrop").remove()},300);if(n){var i=this;i.user().contactShippingAddress&&i.user().contactShippingAddress.repositoryId===t.repositoryId&&(i.user().contactShippingAddress=null),i.user().isB2BUser()&&i.user().contactBillingAddress&&i.user().contactBillingAddress.repositoryId===t.repositoryId&&(i.user().contactBillingAddress=null),i.editingAddressId(t.repositoryId),i.operationPerformedOnAddresses("deleted");var o={};n.indexOf("CC-customerProfile-remove-addr-btn-")===0||n.indexOf("CC-B2CcustomerProfile-remove-addr-btn-")===0?s.profileType===e.PROFILE_TYPE_AGENT?s.request(e.END_POINT_DELETE_PROFILE_ADDRESS,o,i.profileCreateOrUpdateSuccess.bind(i),i.profileAddressSaveFailure.bind(i),i.user().id(),i.editingAddressId()):s.request(e.END_POINT_DELETE_PROFILE_ADDRESS,o,i.profileCreateOrUpdateSuccess.bind(i),i.profileAddressSaveFailure.bind(i),i.editingAddressId()):n.indexOf("CC-account-remove-addr-btn")===0&&s.request(e.END_POINT_DELETE_ADDRESSES,o,i.createOrUpdateSuccess.bind(i),i.saveFailure.bind(i),i.editingAddressId())}},handleCancelUpdateOrganizationAddress:function(){var e=this;e.isProfileAddress(!1),e.isGettingSavedToProfile(!1),e.isGettingSavedToAccount(!1),e.redirectToAccountAddressesListingPage(!0)},redirectToAccountAddressesListingPage:function(e){var t=this;t.user().isSearchInitiatedWithUnsavedChanges(!1),t.interceptedLink!=null&&t.interceptedLink!=undefined&&t.interceptedLink!=""&&!n.isPathEqualTo(t.interceptedLink)?n.goTo(t.interceptedLink):t.isEditMode(!1),t.isDirty(!1),a("#cc-cancel-account-addresses-ModalContainer").modal("hide"),a("body").removeClass("modal-open"),a(".modal-backdrop").remove(),r.clearError(t.WIDGET_ID),t.resetAddressData()},subscribeForChanges:function(){var t=this;t.subscriptionArray.push(t.addressType.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.address1.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.address2.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.address3.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.county.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.country.subscribe(function(n){if(!t.country())t.state(null),t.postalCodePattern("");else for(var r=0;r<t.countriesList().length;r++)t.countriesList()[r].countryCode==t.country()&&t.country(t.countriesList()[r].countryCode);t.state()!==undefined&&t.state()!==""&&t.state(null),t.stateList([]);for(var r=0;r<t.countriesList().length;r++)t.countriesList()[r].countryCode===t.country()&&(t.stateList(t.countriesList()[r].regions),t.stateList()&&t.stateList().length>0&&t.stateList()[0]&&t.stateList()[0].abbreviation&&t.state(t.stateList()[0].abbreviation),t.country()===e.UNITED_STATES?t.postalCodePattern(t.US_POSTAL_CODE_PATTERN):t.country()===e.CANADA?t.postalCodePattern(t.CANADA_POSTAL_CODE_PATTERN):t.postalCodePattern(t.DEFAULT_POSTAL_CODE_PATTERN));t.isDirty(!0)})),t.subscriptionArray.push(t.state.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.city.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.companyName.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.postalCode.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.phoneNumber.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.isDefaultShippingAddress.subscribe(function(e){t.isDirty(!0)})),t.subscriptionArray.push(t.isDefaultBillingAddress.subscribe(function(e){t.isDirty(!0)}))},resetAddressData:function(){var t=this,n=t.subscriptionArray.length;for(var r=0;r<n;r++)t.subscriptionArray[r].dispose();t.subscriptionArray=[],t.addressType(null),t.address1(null),t.address2(null),t.address3(null),t.county(null),t.city(null),t.firstName(null),t.lastName(null),t.companyName(null),t.country(undefined),t.state(undefined),t.postalCode(null),t.phoneNumber(null),t.isDefaultBillingAddress(!1),t.isDefaultShippingAddress(!1),t.validationModel.errors.showAllMessages(!1),t.isCreateNewAddress(!1),t.editingAddressId(null);if(s.profileType===e.PROFILE_TYPE_AGENT){var i=t.dynamicPropertyMetaInfo.dynamicPropertyMetaCache[e.ENDPOINT_CONTACT_INFO_TYPE];if(i&&i.length>0)for(var r=0;r<i.length;r++)i[r].type()==="enum"?i[r].values.removeAll():i[r].value(null);t.clearDynamicProperties()}},beforeAppear:function(t){var r=this;if(!this.user().loggedIn()||this.user().isUserSessionExpired()){n.doLogin(n.getPath(),r.homeRoute);return}r.dynamicPropertyMetaInfo&&(r.populateDynamicPropertiesMetaData(),r.opDynamicProperty("view"));if(r.user().roles().length==0&&r.user().id()==""){r.user().isDelegatedAdmin(!0);return}r.isEditMode(!1),r.populateSiteAndOrganization(),r.loadAddresses(),s.profileType===e.PROFILE_TYPE_AGENT&&(r.subscriptions.push(r.contextManager.selectedSite.subscribe(function(e){r.siteFilter(e)})),r.subscriptions.push(r.contextManager.currentOrganizationId.subscribe(function(e){r.organizationFilter(e),r.loadAddresses(),r.isEditMode(!1)}))),r.isGettingSavedToProfile(!1),r.isGettingSavedToAccount(!1)},populateSiteAndOrganization:function(){var e=this;e.contextManager&&(e.siteFilter(e.contextManager.getSelectedSite()),e.organizationFilter(e.contextManager.getCurrentOrganizationId()))},replaceAllAddress2NullStringWithNull:function(e){var t=e.length;for(var n=0;n<t;n++){var r=e[n];r.address.address2==="null"&&(r.address.address2=null),r.address.address3==="null"&&(r.address.address3=null)}},convertToData:function(t){var n=this,r={};r[e.ORG_ADDRESS_TYPE]=n.addressType();var i={};i[e.ORG_ADDRESS_1]=n.address1(),n.address2()===null||n.address2()===undefined||n.address2()===""?i[e.ORG_ADDRESS_2]="":i[e.ORG_ADDRESS_2]=n.address2(),n.address3()===null||n.address3()===undefined||n.address3()===""?i[e.ORG_ADDRESS_3]="":i[e.ORG_ADDRESS_3]=n.address3(),n.county()===null||n.county()===undefined||n.county()===""?i[e.ORG_COUNTY]="":i[e.ORG_COUNTY]=n.county(),i[e.ORG_COUNTRY]=n.country(),n.stateList().length<=0?i[e.ORG_STATE]="":i[e.ORG_STATE]=n.state(),n.firstName()===null||n.firstName()===undefined||n.firstName()===""?i[e.PROFILE_FIRST_NAME]="":i[e.PROFILE_FIRST_NAME]=n.firstName(),n.lastName()===null||n.lastName()===undefined||n.lastName()===""?i[e.PROFILE_LAST_NAME]="":i[e.PROFILE_LAST_NAME]=n.lastName(),n.companyName()===null||n.companyName()===undefined||n.companyName()===""?i[e.ORG_COMPANY_NAME]="":i[e.ORG_COMPANY_NAME]=n.companyName(),i[e.ORG_CITY]=n.city(),i[e.ORG_POSTAL_CODE]=n.postalCode(),n.phoneNumber()===null||n.phoneNumber()===undefined||n.phoneNumber()===""?i[e.ORG_PHONE_NUMBER]="":i[e.ORG_PHONE_NUMBER]=n.phoneNumber(),i[e.ORG_IS_DEFAULT_BILLING_ADDRESS]=n.isDefaultBillingAddress(),i[e.ORG_IS_DEFAULT_SHIPPING_ADDRESS]=n.isDefaultShippingAddress(),!n.user().isB2BUser()&&n.profileAddresses().length===0&&(i[e.ORG_IS_DEFAULT_SHIPPING_ADDRESS]=!0);for(var s=0;s<n.dynamicProperties().length;s++)n.dynamicProperties()[s].type()==="enum"?i[n.dynamicProperties()[s].id()]=n.dynamicProperties()[s].values:i[n.dynamicProperties()[s].id()]=n.dynamicProperties()[s].value();return r[e.ORG_ADDRESS]=i,r},fetchCountryandStateName:function(e,t){var n=this,r=null,i={};for(var s=0;s<n.countriesList().length;s++)if(e===n.countriesList()[s].countryCode){r=n.countriesList()[s],i.country=n.countriesList()[s].displayName;break}if(r.regions&&r.regions.length>0)for(var o=0;o<r.regions.length;o++)if(t===r.regions[o].abbreviation){i.state=r.regions[o].displayName;break}return i},triggerPageChangeEvent:function(){var e=this,t=e.subscriptions.length;for(var n=0;n<t;n++)e.subscriptions[n].dispose();e.subscriptions=[]},returnUniqueValueForId:function(){var e=this;return Math.floor(Math.random()*100+1)+"_"+Math.floor(Math.random()*100+1)+"_"+Math.floor(Math.random()*100+1)}}})