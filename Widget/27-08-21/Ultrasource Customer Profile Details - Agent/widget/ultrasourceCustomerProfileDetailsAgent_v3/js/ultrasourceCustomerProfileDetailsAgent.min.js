define(["knockout","notifier","pubsub","spinner","xDomainProxy","jquery","ccConstants","CCi18n","ccRestClient","agentViewModels/agentUtils/agent-utils","agentViewModels/order-search","agentViewModels/account-site-selector","agentViewModels/agent-context-manager","viewModels/paymentsViewModel","viewModels/storeCreditContainer","viewModels/loyalty","agentViewModels/agentConfiguration"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){"use strict";return{WIDGET_ID:"customerProfile",ALL_ACCOUNTS:"AllAccounts",ONLY_ACTIVE_ACCOUNTS:"ActiveAccounts",ONLY_DELEGATED_ADMIN_ACCOUNTS:"DelegatedAdminAccounts",ONLY_APPROVER_ACCOUNTS:"ApproverAccounts",loaded:e.observable(!1),notesType:"customer",subscriptions:[],contextManager:h.getInstance(),opDynamicProperty:e.observable(),spinnerOptions:{parent:"#cc-customerDisplay",posTop:"50%",posLeft:"50%"},beforeAppear:function(e){var t=this;t.loaded(!0),t.subscriptions.push(t.accountAndSiteSelector.activeSites.subscribe(function(){var e=t.accountAndSiteSelector.activeSites();e&&e.length>0?t.isAccountWithNoContracts(!1):t.isAccountWithNoContracts(!0),t.updateSiteGlobalProperties(!1),t.getSiteSpecificProperties()})),t.opDynamicProperty("update"),t.displayCustomer()},onLoad:function(r){var i=r.user();r.updateSiteGlobalProperties=e.observable(!1),r.marketingMailsTextForSite=e.pureComputed(function(){return u.t("ns.agentcustomerprofiledetails:resources.marketingMailsText",{siteName:r.accountAndSiteSelector.selectedSiteInfo().name})},r),r.newOrIncompleteOrderLinkText=e.observable(),r.hasIncompleteOrder=e.observable(),r.incompleteOrder=e.observable(),r.loyaltyFlag=e.observable(!1),r.totalLoyaltyPrograms=e.observable(),r.isEnrollProperty=e.observable(null),r.paymentsContainer=p.getInstance(),r.storeCreditContainer=d.getInstance(),r.accountAndSiteSelector=c,r.isAccountWithNoContracts=e.observable(!1),r.currencyObject=e.observable(i.selectedPriceListGroup().currency),r.accountAndSiteSelector.selectedSite.subscribe(r.handleSiteSelection.bind(r)),r.accountAndSiteSelector.currentOrganizationId.subscribe(r.handleOrganizationSelection.bind(r)),s.Topic(n.topicNames.USER_RESET_PASSWORD_SUCCESS).subscribe(r.generatePasswordSuccess.bind(r)),s.Topic(n.topicNames.USER_RESET_PASSWORD_FAILURE).subscribe(r.generatePasswordFailure.bind(r)),s.Topic(n.topicNames.USER_PROFILE_UPDATE_SUCCESSFUL).subscribe(r.updateCustomerSuccess.bind(r)),s.Topic(n.topicNames.USER_PROFILE_UPDATE_FAILURE).subscribe(r.updateCustomerFailure.bind(r)),s.Topic(n.topicNames.USER_PROFILE_UPDATE_NOCHANGE).subscribe(r.closeSpinner.bind(r)),s.Topic(n.topicNames.USER_PROFILE_UPDATE_INVALID).subscribe(r.closeSpinner.bind(r)),s.Topic(n.topicNames.USER_PROFILE_UPDATE_INVALID).subscribe(function(){t.sendError(r.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.updateErrorMsg"),!0)}),s.Topic(n.topicNames.PAGE_CHANGED).subscribe(r.triggerPageChangeEvent.bind(r))},handleOrganizationSelection:function(){var e=this;e.showIncompleteOrders()},handleSiteSelection:function(){var e=this;e.showIncompleteOrders();var t=e.accountAndSiteSelector.activeSites();e.user().getSiteSpecificProperties(t)},displayCustomer:function(){var e=this;e.checkForLoyalty(),e.getStoreCreditBalance(),e.getSiteSpecificProperties(),(e.contextManager.currentOrganizationId()||e.contextManager.selectedSite())&&e.showIncompleteOrders()},checkForLoyalty:function(){var e=this;e.isEnrollForLoyalty()?(e.loyaltyFlag(!0),e.loadLoyaltyPrograms()):e.totalLoyaltyPrograms(0)},isEnrollForLoyalty:function(){var e=this,t=e.user(),n=t.dynamicProperties();if(n&&n.length>0)for(var r in n)if(n[r].id()==o.ENROLLED_FOR_LOYALTY)return n[r].value()==1?(e.isEnrollProperty(!0),e.isProfileEnrolledForLoyalty()):(e.isEnrollProperty(!1),!1);return e.isProfileEnrolledForLoyalty()},isProfileEnrolledForLoyalty:function(){var e=this,t=e.user(),n=t.loyaltyPrograms();if(n)for(var r=0;r<n.length;r++)if(n[r].status&&n[r].status===o.ENROLLED)return!0;return!1},loadLoyaltyPrograms:function(){var e=this,t=e.user(),n=[],r={};r.paymentMethodType=o.LOYALTY_POINTS_PAYMENT_TYPE,n.push(r),e.paymentsContainer.inquireBalance(e.loadLoyaltyProgramsSuccess.bind(e),e.loadLoyaltyProgramsFailure.bind(e),n,t.id())},loadLoyaltyProgramsSuccess:function(e){var t=this,n=t.user(),r=new v;t.paymentsContainer.populateViewModelWithServerData(r,e),n.loyaltyViewModel(r),r.loyaltyPrograms.length>0&&t.totalLoyaltyPrograms(r.loyaltyPrograms.length),t.loyaltyFlag(!1)},loadLoyaltyProgramsFailure:function(e){var n=this;n.loyaltyFlag(!1),n.totalLoyaltyPrograms(0),t.sendError(n.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.loyaltyProgramRetrievalErrorText"))},sendResetPasswordLink:function(){var e=this,t=e.user(),n=t.emailAddress();t.resetForgotPassword(n)},generatePasswordSuccess:function(e){var n=this;t.sendSuccess(n.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.customerGenerateResetPasswordLinkSuccessMsg"))},generatePasswordFailure:function(e){var n=this;t.sendError(n.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.customerGenerateResetPasswordLinkErrorMsg"))},getStoreCreditBalance:function(){var e=this,n=e.user(),r=function(e){n.storeCreditContainer().populateViewModelWithServerData(e)},i=function(n){t.sendError(e.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.storeCreditRetrievalErrorText"))};e.paymentsContainer.retrieveStoreCreditBalance(r,i,n.id())},redirectToStore:function(){var e=this,n=function(n){var r=n.access_token,i=e.getSelectedSiteProductionUrl();if(!e.isValidURL(i))t.sendError(e.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.productionURLMissingMessage"));else{s("#shopperRedirectForm").attr("action",i),s("#cc-shopper-behalf-token").val(r);var o=window.location.href;s("#cc-shopper-agent-redirect-url").val(o),s("#cc-shopper-organizationId-value").val(e.contextManager.currentOrganizationId()),s("#cc-shopper-priceListGroupId-value").val(e.contextManager.getPriceListGroup());var a=s("#shopperRedirectForm")[0];a.submit()}},r=function(n){t.sendError(e.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.customerTokenRetrievalErrorText"))};e.user().getOnBehlafOfToken(n,r)},getSelectedSiteProductionUrl:function(){var e=this.accountAndSiteSelector.selectedSiteInfo();return e.productionURL?"//"+e.productionURL:e.productionURL},isValidURL:function(e){return e===null||e==="undefined"||e===""?null:e},switchGlobalEmailPrefOptionChange:function(e){var t=this,n=t.user();n.emailMarketingMails(n.receiveEmailGlobally());var r=e.target.checked;return n.originalReceiveEmailGlobally!=r?t.updateSiteGlobalProperties(!0):t.updateSiteGlobalProperties(!1),!0},updateCustomer:function(){var e=this,n=e.user();r.create(e.spinnerOptions),n.handleUpdateProfile();var i=function(){e.getSiteSpecificProperties(),t.sendSuccess(e.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.customerUpdateSiteSpecifcPropertySuccessMsg")),r.destroy()},s=function(){t.sendError(e.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.customerUpdateSiteSpecifcPropertyFailureMsg")),r.destroy()};e.updateSiteGlobalProperties()&&n.updateSiteSpecificProperites(e.accountAndSiteSelector.activeSites(),i,s)},updateCustomerSuccess:function(e){var n=this,r=n.user(),i=m.getPriceListGroups();e.priceListGroup=i[e.priceListGroup.repositoryId],r.populateUserViewModel(e),t.sendSuccess(n.WIDGET_ID,u.t("ns.agentcustomerprofiledetails:resources.customerProfileUpdateSuccessMsg")),n.updateSiteGlobalProperties()||(n.getSiteSpecificProperties(),n.closeSpinner())},closeSpinner:function(){r.destroy()},getSiteSpecificProperties:function(){var e=this,t=e.accountAndSiteSelector.activeSites();e.user().getSiteSpecificProperties(t),e.updateSiteGlobalProperties(!1)},updateCustomerFailure:function(e){var n=this;t.sendError(n.WIDGET_ID,n.translate("errorHeader",{result:e}),!0),r.destroy()},cancelUpdates:function(){var e=this,t=e.user();r.create(e.spinnerOptions),t.getCurrentUser(null,null,e.cancelUpdatesSuccessCallback.bind(e),e.cancelUpdatesFailCallback.bind(e))},cancelUpdatesSuccessCallback:function(){r.destroy()},cancelUpdatesFailCallback:function(){r.destroy()},enableSaveButton:function(){var e=this,t=e.user();return t.firstName.isModified()||t.lastName.isModified()},showIncompleteOrders:function(){var e=this,t=e.contextManager.selectedSite(),n=e.contextManager.currentOrganizationId(),r=new l,i={},s='state eq "INCOMPLETE" and profileId eq "'+e.contextManager.getShopperProfileId()+'"';t&&(s=s+' and siteId eq "'+t+'"'),n&&(s=s+' and organizationId eq "'+n+'"'),i[o.Q]=s,i[o.FIELDS_QUERY_PARAM]="items.organization,items.commerceItems,items.priceGroupId,items.payTaxInSecondaryCurrency,items.secondaryCurrency,items.payShippingInSecondaryCurrency,items.secondaryCurrencyCode,items.priceInfo,items.siteId,items.id",i[o.PARAM_QUERY_FORMAT]=o.PARAM_QUERY_FORMAT_SCIM,i[o.OFFSET]=0,i[o.LIMIT]=1,i.sort="lastModifiedDate:desc",r.getIncompleteOrdersForUser(i,e.getIncompleteOrderDetailsSuccess.bind(e),e.getIncompleOrderDetailsFailure.bind(e))},showOrdersPage:function(){var e=this,t=e.hasIncompleteOrder(),n=e.user();t?(e.contextManager.setCurrentOrganizationId(e.incompleteOrder().organization?e.incompleteOrder().organization.repositoryId:null),e.contextManager.setSelectedSite(e.incompleteOrder().siteId),e.contextManager.setPriceListGroup(e.incompleteOrder().priceGroupId)):e.contextManager.setPriceListGroup(n.priceListGroup.id());var r=e.contextManager.export();n.validateAndRedirectPage(e.links().agentCheckout.route+"?context="+encodeURIComponent(r))},getIncompleteOrderDetailsSuccess:function(e){var t=this;t.updateCartText(e)},getIncompleOrderDetailsFailure:function(e){var n=this;t.sendError(n.WIDGET_ID,u.t("ns.ultrasourceCustomerProfileDetailsAgent:resources.profileLoadOrderError"))},updateCartText:function(e){var t=this;if(e&&e.items&&e.items.length>0){var n=t.getIncompleteOrderText(e);t.newOrIncompleteOrderLinkText(n),t.hasIncompleteOrder(!0),t.incompleteOrder(e.items[0])}else{var r=u.t("ns.ultrasourceCustomerProfileDetailsAgent:resources.createOrderLink");t.newOrIncompleteOrderLinkText(r),t.hasIncompleteOrder(!1)}},getIncompleteOrderText:function(e){var t=this,n="",r=e.items[0],i=r.commerceItems,s=0;i.forEach(function(e){s+=e.quantity});var o=m.getPriceListGroups(),a=f.getPriceListGroupInfo(o,r.priceGroupId),l=r.priceInfo.total,c;a!=null&&(c=a.currency),c||(c=t.currencyObject());var h=c.symbol,p=f.formatPrice(l,c.fractionalDigits);h.match(/^[0-9a-zA-Z]+$/)&&(h+=" ");var d=f.formatNumber(s);if(r.payShippingInSecondaryCurrency||r.payTaxInSecondaryCurrency){var v=f.getSecondaryCurrency(r.secondaryCurrencyCode),g=r.priceInfo.primaryCurrencyTotal,y=r.priceInfo.secondaryCurrencyTotal,b=d>1?"completeOrderDetailTextInMixCurrency_plural":"completeOrderDetailTextInMixCurrency";n=u.t("ns.ultrasourceCustomerProfileDetailsAgent:resources."+b,{count:d,primaryCurrencySymbol:h,totalPrimaryPrice:f.formatPrice(g,c.fractionalDigits),secondaryCurrencySymbol:v.symbol,totalSecondaryPrice:f.formatPrice(y,v.fractionalDigits)})}else b=d>1?"completeOrderDetailText_plural":"completeOrderDetailText",n=u.t("ns.ultrasourceCustomerProfileDetailsAgent:resources."+b,{count:d,currency:h,totalPrice:p});return n},getPointTypeText:function(e){var t="";if(e)for(var n=0;n<e.length;n++)n==0?t=e[n].pointsBalance+" "+e[n].membershipType+" "+e[n].pointsType:t=t+", "+e[n].pointsBalance+" "+e[n].membershipType+" "+e[n].pointsType;return t},rolesHaveChanged:function(){var e=this;e.user().isUserDataModified(!0)},triggerPageChangeEvent:function(){var e=this,t=e.subscriptions.length;for(var n=0;n<t;n++)e.subscriptions[n].dispose()}}})