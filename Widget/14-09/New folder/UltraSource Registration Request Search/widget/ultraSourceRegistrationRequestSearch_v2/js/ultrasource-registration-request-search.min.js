define(["knockout","CCi18n","ccConstants","viewModels/registrationRequestSearch","spinner"],function(e,t,n,r,i){"use strict";return{firstName:e.observable(),lastName:e.observable(),email:e.observable(),companyName:e.observable(),requestNumber:e.observable(),queryParamString:"",currentFilterOption:e.observable(),filterQuery:"",sortDirections:e.observable(),resultListTemplate:e.observable(),spinnerOptions:{parent:"body",posTop:"50%",posLeft:"50%"},columnList:e.observable(),onLoad:function(e){e.setTableMetaData(),e.filterOptions=[{value:"all",label:t.t("ns.registrationRequestSearch:resources.filterTextAll")},{value:"rejected",label:t.t("ns.registrationRequestSearch:resources.registrationRequestRejectedText")},{value:"moreInfoNeeded",label:t.t("ns.registrationRequestSearch:resources.registrationRequestMoreInfoText")},{value:"review",label:t.t("ns.registrationRequestSearch:resources.registrationRequestReviewText")},{value:"new",label:t.t("ns.registrationRequestSearch:resources.registrationRequestNewText")}],e.registrationRequestSearchViewModel=new r(e.createSpinner.bind(e),e.destroySpinner.bind(e)),e.currentFilterOption(e.filterOptions[0].value),e.registrationRequestItemsPerPage&&e.registrationRequestItemsPerPage()?e.registrationRequestSearchViewModel.itemsPerPage=parseInt(e.registrationRequestItemsPerPage()):e.registrationRequestSearchViewModel.itemsPerPage=10,e.registrationOptions=[{value:!0,label:t.t("ns.registrationRequestSearch:resources.accountText")},{value:!1,label:t.t("ns.registrationRequestSearch:resources.contactText")}],e.registrationRequestSearchViewModel.isAccountSearch.subscribe(function(t){e.registrationRequestSearchViewModel.isSearchPerformed(!1),t?(e.sortDirections(e.accountRequestSortOptions),e.columnList(e.accountRequestColumnOptions)):(e.sortDirections(e.contactRequestSortOptions),e.columnList(e.contactRequestColumnOptions))}),e.registrationRequestSearchViewModel.isAccountSearch(!0)},setTableMetaData:function(){this.accountRequestSortOptions={},this.accountRequestSortOptions[n.REGISTRATION_REQUEST_ID]="both",this.accountRequestSortOptions[n.ORG_NAME]="both",this.accountRequestSortOptions[n.REGISTRATION_REQUEST_DATE]="both",this.accountRequestSortOptions[n.REGISTRATION_REQUEST_STATUS]="both",this.accountRequestColumnOptions=[{columnNameHeader:"idText",columnSortKey:n.REGISTRATION_REQUEST_ID,allowSort:!0},{columnNameHeader:"companyNameText",columnSortKey:n.ORG_NAME,allowSort:!0},{columnNameHeader:"createdTimeText",columnSortKey:n.REGISTRATION_REQUEST_DATE,allowSort:!0},{columnNameHeader:"statusText",columnSortKey:n.REGISTRATION_REQUEST_STATUS,allowSort:!0}],this.contactRequestSortOptions={},this.contactRequestSortOptions[n.REGISTRATION_REQUEST_ID]="both",this.contactRequestSortOptions[n.SCIM_EMAIL]="both",this.contactRequestSortOptions[n.SCIM_FIRST_NAME]="both",this.contactRequestSortOptions[n.SCIM_LAST_NAME]="both",this.contactRequestSortOptions[n.SITE_ID]="both",this.contactRequestSortOptions[n.REGISTRATION_REQUEST_DATE]="both",this.contactRequestSortOptions[n.REGISTRATION_REQUEST_STATUS]="both",this.contactRequestColumnOptions=[{columnNameHeader:"idText",columnSortKey:n.REGISTRATION_REQUEST_ID,allowSort:!0},{columnNameHeader:"emailText",columnSortKey:n.SCIM_EMAIL,allowSort:!0},{columnNameHeader:"lastNameText",columnSortKey:n.SCIM_LAST_NAME,allowSort:!0},{columnNameHeader:"firstNameText",columnSortKey:n.SCIM_FIRST_NAME,allowSort:!0},{columnNameHeader:"siteText",columnSortKey:n.SITE_ID,allowSort:!1},{columnNameHeader:"createdTimeText",columnSortKey:n.REGISTRATION_REQUEST_DATE,allowSort:!0},{columnNameHeader:"statusText",columnSortKey:n.REGISTRATION_REQUEST_STATUS,allowSort:!0}]},beforeAppear:function(e){},redirectToRequestDetailsPage:function(e,t,r){var i=this;i.registrationRequestSearchViewModel.isAccountSearch()?i.user().navigateToPage(window.applicationContextPath+this.links().agentRegistrationRequestDetail.route+"/"+e):i.user().navigateToPage(window.applicationContextPath+this.links().agentRegistrationRequestDetail.route+"/"+e+"?"+n.CONTACT_SEARCH_IDENTIFIER)},performSearch:function(){var e=this;e.createSpinner(),e.currentFilterOption(e.filterOptions[0].value),e.sortDirections().createdTime="desc",e.filterQuery="",e.queryParamString='status ne "approved"',e.sortDirections().createdTime="desc";if(e.firstName()){e.queryParamString&&(e.queryParamString+=" and ");var t=e.getSCIMCompatibleString(e.firstName());e.queryParamString+=' profile.firstName co "'+t+'"'}if(e.lastName()){e.queryParamString&&(e.queryParamString+=" and ");var n=e.getSCIMCompatibleString(e.lastName());e.queryParamString+=' profile.lastName co "'+n+'"'}if(e.email()){e.queryParamString&&(e.queryParamString+=" and ");var r=e.getSCIMCompatibleString(e.email());e.queryParamString+=' profile.email co "'+r+'"'}if(e.requestNumber()){e.queryParamString&&(e.queryParamString+=" and ");var i=e.getSCIMCompatibleString(e.requestNumber());e.queryParamString+=' id co "'+i+'"'}if(e.companyName()){e.queryParamString&&(e.queryParamString+=" and ");var s=e.getSCIMCompatibleString(e.companyName()),o=e.registrationRequestSearchViewModel.isAccountSearch()?" name co ":" requestedOrganizationName co ";e.queryParamString+=o+'"'+s+'"'}var u={};u.q=e.queryParamString,u.sort="createdTime:desc",e.registrationRequestSearchViewModel.performSearch(1,u,e.parseResponseItem.bind(e))},reset:function(){var e=this;e.firstName(""),e.lastName(""),e.email(""),e.companyName(""),e.requestNumber(""),e.filterQuery="",e.registrationRequestSearchViewModel.isSearchPerformed(!1),e.registrationRequestSearchViewModel.clearData()},getSCIMCompatibleString:function(e){var t=this;return e=e.replace(/\\/g,"\\\\"),e=e.replace(/"/g,'\\"'),e},parseResponseItem:function(e){var r=this,i={};return i[n.REGISTRATION_REQUEST_ID]=e.id,i[n.ORG_NAME]=e.name,i[n.REGISTRATION_REQUEST_DATE]=r.formatRegistrationRequestDate(e.createdTime),i[n.REGISTRATION_REQUEST_STATUS]=r.getRequestStatus(e.status),i[n.REGISTRATION_REQUEST_ID]=e.id,r.registrationRequestSearchViewModel.isAccountSearch()||(i[n.SCIM_EMAIL]=e.profile?e.profile.email:t.t("ns.registrationRequestSearch:resources.nameNotRetainedText"),i[n.SCIM_FIRST_NAME]=e.profile?e.profile.firstName:t.t("ns.registrationRequestSearch:resources.nameNotRetainedText"),i[n.SCIM_LAST_NAME]=e.profile?e.profile.lastName:t.t("ns.registrationRequestSearch:resources.nameNotRetainedText"),i[n.SITE_ID]=e.site?e.site.name?e.site.name:e.site.id:""),e.status=="rejected"?i.statusIcon="fa fa-times-circle rejectedIcon":e.status=="moreInfoNeeded"&&(i.statusIcon="fa fa-question-circle moreInfoNeededIcon"),i},formatRegistrationRequestDate:function(e){var t=this,n=e,r=t.locale()?t.locale():"en";if(e){var i=new Date(e);n=i.toLocaleString();if(Intl&&Intl.DateTimeFormat){var s=new Intl.DateTimeFormat(r,{month:"long",day:"numeric",year:"numeric"});n=s.format(i)}}return n},getRequestStatus:function(e){var r="";if(e)switch(e){case n.REGISTRATION_REQUEST_TYPES_REJECT:r=t.t("ns.registrationRequestSearch:resources.registrationRequestRejectedText");break;case n.REGISTRATION_REQUEST_TYPES_MORE_INFO_NEEDED:r=t.t("ns.registrationRequestSearch:resources.registrationRequestMoreInfoText");break;case n.REGISTRATION_REQUEST_TYPES_REVIEW:r=t.t("ns.registrationRequestSearch:resources.registrationRequestReviewText");break;case n.REGISTRATION_REQUEST_TYPES_NEW:r=t.t("ns.registrationRequestSearch:resources.registrationRequestNewText")}return r},onFilterOptionChange:function(e,t){var n=this;n.createSpinner();var r=t.target.value;r=r!=="all"?n.queryParamString+"and status eq "+'"'+r+'"':n.queryParamString,n.filterQuery=r;var i={};i.q=r,i.sort="createdTime:desc",this.registrationRequestSearchViewModel.performSearch(1,i,n.parseResponseItem.bind(n))},sort:function(e,t,r,i){var s=this;if(i.type==="keyup"){var o=i.which?i.which:i.keyCode;if(o!=n.KEY_CODE_ENTER)return}s.createSpinner(),s.updateSortDirections(e,t),s.sortDirections.valueHasMutated();var u=e+":"+t,a={};s.filterQuery?a.q=s.filterQuery:a.q=s.queryParamString,a.sort=u,this.registrationRequestSearchViewModel.performSearch(this.registrationRequestSearchViewModel.currentPage(),a,s.parseResponseItem.bind(s))},updateSortDirections:function(e,t){var n=this;n.sortDirections()[e]=t;for(var r in n.sortDirections())r!==e&&(n.sortDirections()[r]="both")},destroySpinner:function(){i.destroy()},createSpinner:function(){i.create(this.spinnerOptions)}}})