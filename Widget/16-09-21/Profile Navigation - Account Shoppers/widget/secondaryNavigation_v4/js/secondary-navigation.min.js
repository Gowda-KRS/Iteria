define(["knockout","jquery","navigation","pubsub","ccConstants","ccRestClient"],function(e,t,n,r,i,s){"use strict";return{WIDGET_ID:"secondaryNavigation",keyValuePair:e.observableArray([]),currentTab:e.observable(),userRoles:[],isUserB2B:!1,subscriptions:[],activeTab:e.observable(),onLoad:function(n){n.isMobile=e.observable(!1),t(window).resize(function(){n.checkResponsiveFeatures(t(window).width())}),n.isUserB2B=n.user().isB2BUser();if(n.isUserB2B)for(var i=0;i<n.user().rolesForCurrentOrganization().length;i++)n.userRoles.push(n.user().rolesForCurrentOrganization()[i]);s.profileType!=="agentUI"?n.initializeWidgetData(n.displayAndURL()):(n.agentConfiguration=require("agentViewModels/agentConfiguration"),t.Topic(r.topicNames.PAGE_CHANGED).subscribe(n.triggerPageChangeEvent.bind(n)))},beforeAppear:function(e){var n=this;if(s.profileType==="agentUI"){n.agentConfiguration=require("agentViewModels/agentConfiguration"),n.agentConfigurationData=n.agentConfiguration.getConfigurationProperty(i.AGENT_CONFIGURATIONS),n.subscriptions.push(n.currentTab.subscribe(function(e){n.activeTab(e)})),n.isUserB2B=n.user().isB2BUser();var r=JSON.parse(n.displayAndURL().replace(/'/g,'"'));n.initializeAgentWidgetData(n.displayAndURL()),r.length>0&&r[0][2]===undefined||n.widgetSubscriptions()}else n.initializeWidgetData(n.displayAndURL());n.currentTab("/"+e.pageId),n.checkResponsiveFeatures(t(window).width())},triggerPageChangeEvent:function(){var e=this,t=e.subscriptions.length;for(var n=0;n<t;n++)e.subscriptions[n].dispose();e.subscriptions=[]},widgetSubscriptions:function(){var e=this;e.isUserB2B&&e.subscriptions.push(e.user().rolesForCurrentOrganization.subscribe(function(t){e.userRoles=[],e.isUserB2B=e.user().isB2BUser();var n=e.currentTab();if(e.isUserB2B)for(var r=0;r<e.user().rolesForCurrentOrganization().length;r++)e.userRoles.push(e.user().rolesForCurrentOrganization()[r]);s.profileType!=="agentUI"?e.initializeWidgetData(e.displayAndURL()):e.initializeAgentWidgetData(e.displayAndURL());var i=!0;for(var o=0;o<e.keyValuePair().length;o++){if(n===e.keyValuePair()[o].route){i=!0;break}i=!1}i?e.currentTab(n):(e.currentTab(e.links().agentCustomerDetails.route),e.user().navigateToPage(e.links().agentCustomerDetails.route))}))},checkResponsiveFeatures:function(e){e>=768?this.isMobile(!1):e<768&&this.isMobile(!0)},initializeWidgetData:function(e){if(e){this.keyValuePair.removeAll();var t=JSON.parse(e.replace(/'/g,'"'));if(!this.isUserB2B)for(var n=0;n<t.length;n++)t[n][0]!==""&&t[n][1]!==""&&this.keyValuePair.push({displayName:t[n][0],route:t[n][1]});else if(this.isUserB2B)for(var n=0;n<t.length;n++){var r=t[n][2].split(",");for(var i=0;i<r.length;i++)if(this.validateUserRole(this.userRoles,r[i])){t[n][0]!==""&&t[n][1]!==""&&this.keyValuePair.push({displayName:t[n][0],route:t[n][1]});break}}}},validateUserRole:function(e,t){var n=e.length,r=!1;for(var i=0;i<n;i++)if(e[i]===t){r=!0;break}return r},initializeAgentWidgetData:function(e){var t=this,n=require("agentViewModels/agent-context-manager"),r=n.getInstance().getShopperProfileId(),s=n.getInstance().getSelectedSite(),o=n.getInstance().getCurrentOrganizationId(),u="";r&&t.metaPageType&&t.metaPageType()===i.AGENT_PROFILE_PAGE_META_TYPE&&(u+="?"+i.AGENT_PARAM_CUSTOMER_ID+"="+r);var a=!0;if(e){t.keyValuePair([]);var f=JSON.parse(e.replace(/'/g,'"'));t.isUserB2B||(f=t.showB2CUserSpecificTabNames(f));if(f&&f.length>0)if(f[0][2]===undefined){var f=JSON.parse(t.displayAndURL().replace(/'/g,'"'));for(var l=0;l<f.length;l++)t.keyValuePair.push({displayName:f[l][0],route:f[l][1],url:f[l][1]+u})}else{var c=null;for(var l=0;l<f.length;l++){c=f[l][2].split(",");for(var h=0;h<c.length;h++){if(c[h]===""){t.keyValuePair.push({displayName:f[l][0],route:f[l][1],url:f[l][1]+u});break}c[h]==="approver"&&t.agentConfigurationData&&!t.agentConfigurationData.orderApprovalsAllowedThroughAgent&&(a=!1),c[h]==="admin"&&t.agentConfigurationData&&!t.agentConfigurationData.delegatedAdminAllowedThroughAgent&&(a=!1);if(t.isUserB2B&&a&&t.user().rolesForCurrentOrganization().indexOf(c[h])!==-1){t.keyValuePair.push({displayName:f[l][0],route:f[l][1],url:f[l][1]+u});break}a=!0}}}}},showB2CUserSpecificTabNames:function(e){for(var t=0;t<e.length;++t)if(e[t][1]==="/agentAddressBook"){e[t][0]="addressBookText";break}return e},onClick:function(e,t){var n=this;n.currentTab(e.route)}}})