define(["knockout","spinner","ccRestClient","agentViewModels/order-search","jquery","pubsub","agentViewModels/agentUtils/agent-utils","agentViewModels/agent-context-manager","ccConstants","viewModels/site-listing","currencyHelper","agentViewModels/agentConfiguration","notifier","CCi18n"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){"use strict";return{disableSubmittedInLastDaysField:!0,MIN_CHARACTERS:3,MAX_RESULTS:100,productSearchValue:e.observable(),accountSearchValue:e.observable(),orderStatesMap:e.observableArray([]),sites:e.observableArray([]),countries:e.observableArray([]),regions:e.observableArray([]),spinnerOptions:{parent:"#page",posTop:"50%",posLeft:"50%"},onLoad:function(t){t.initOrderSearchCriteriaViewModel(),t.initAdvancedSearchCriteria(),t.selectedCurrency=e.observable(l.currencyObject()),u.getInstance().clearAgentContextHeader(),o.removeFromStorage(a.LOCAL_STORAGE_ORGANIZATION_ID),o.removeFromStorage(a.LOCAL_STORAGE_AGENT_CONTEXT),o.removeFromStorage(a.LOCAL_STORAGE_SITE_ID),u.getInstance().removeCatalogId(),t.orderSearchViewModel=new r,t.orderSearchViewModel.itemsPerPage=parseInt(t.itemsPerPage());var n={};t.orderSearchViewModel.loadOrderStates(n,t.loadOrderStatesSuccess.bind(t),t.loadOrderStatesFailure.bind(t)),t.loadOrderSites();var i={sortByCode:!1,regions:!0};t.orderSearchViewModel.loadCountries(i,t.loadCountriesSuccess.bind(t),t.loadCountriesFailure.bind(t)),t.timeUnits.push(t.resources().days),t.timeUnits.push(t.resources().weeks),t.timeUnits.push(t.resources().months),t.searchOptions.push(t.resources().advancedSearchBillingAndShipping),t.searchOptions.push(t.resources().advancedSearchBilling),t.searchOptions.push(t.resources().advancedSearchShipping),t.disableSubmittedInLastDaysField=e.computed(function(){var e=this;if(e.isAdvancedSearch()&&(e.startDate()||e.endDate()))return e.timeValueForLastOrders(""),e.timeUnitForLastOrders(t.resources().days),!1;if(!e.startDate()&&!e.endDate())return!0},t)},beforeAppear:function(e){this.sites(f.activeSites()),u.getInstance().clearAgentContextHeader(),o.removeFromStorage(a.LOCAL_STORAGE_ORGANIZATION_ID),o.removeFromStorage(a.LOCAL_STORAGE_AGENT_CONTEXT)},performOrderSearch:function(){t.create(this.spinnerOptions);var e=c.isTextSearchEnabled()?this.getTextSearchCriteria():this.getSCIMSearchCriteria();this.orderSearchViewModel.performSearch(0,e,this.createSpinnerCallBack.bind(this),this.distroySpinnerCallBack.bind(this),this.onSearchFailure.bind(this))},onSearchFailure:function(e){var t=this;h.sendError(t.widgetId(),e.message,!0)},distroySpinnerCallBack:function(){t.destroy()},createSpinnerCallBack:function(){t.create(this.spinnerOptions)},loadOrderStatesSuccess:function(e){this.orderStatesMap(e)},loadOrderStatesFailure:function(e){var t=this.resources().orderStatesListingErrorText,n=e.message,r=e.errorCode;o.notifyErrorMessage(t,n,r)},loadOrderSites:function(){var e=this;f.sites.subscribe(function(){e.sites(f.activeSites())})},loadCountriesSuccess:function(e){this.countries(e)},loadCountriesFailure:function(e){var t=this.resources().countryListingErrorText,n=e.message,r=e.errorCode;o.notifyErrorMessage(t,n,r)},initOrderSearchCriteriaViewModel:function(){var t=this;t.accountNameSelected=e.observableArray([]),t.orderId=e.observable(""),t.email=e.observable(""),t.firstName=e.observable(""),t.lastName=e.observable(""),t.account=e.observable(""),t.approver=e.observable(""),t.selectedSite=e.observable(""),t.selectedOrderState=e.observable(""),t.skuId=e.observable(""),t.productId=e.observable(""),t.timeValueForLastOrders=e.observable(""),t.timeUnitForLastOrders=e.observable(""),t.phone=e.observable(""),t.isEditPhone=e.observable(!1),t.isAdvancedSearch=e.observable(!1),t.timeUnits=[],t.timeValueForLastOrders.extend({pattern:{params:"^[0-9]",message:t.resources().timeValueValidationMessage},max:{params:a.SEARCH_CREATED_IN_LAST_FIELD_MAXIMUM_VALUE,message:t.resources().maxCreatedInLastValidationMsg}}),t.isEditPhone.subscribe(function(e){e||t.phone(t.phone().replace(/[^0-9]+/g,""))})},updateProductId:function(e){this.productId(e)},isTimeSpanEntered:function(){return this.timeValueForLastOrders()?!0:!1},handleAccountSearchValueUpdate:function(e,t){var n=this;t&&n.orderSearchViewModel.searchCriteria.account?n.elements["account-search"].accountSearchValue(n.orderSearchViewModel.searchCriteria.account):e=e?n.accountNameSelected([e]):n.accountNameSelected([])},initAdvancedSearchCriteria:function(){var t=this;t.startDate=e.observable(),t.isStartDateValid=e.observable(!0),t.endDate=e.observable(),t.isEndDateValid=e.observable(!0),t.searchType=e.observable(t.resources().advancedSearchBillingAndShipping),t.billingFirstName=e.observable(""),t.billingLastName=e.observable(""),t.country=e.observable(""),t.addressLine1=e.observable(""),t.addressLine2=e.observable(""),t.city=e.observable(""),t.state=e.observable(""),t.postalCode=e.observable(""),t.searchOptions=[],t.startDate.subscribe(t.validateStartDate.bind(t)),t.endDate.subscribe(t.validateEndDate.bind(t)),t.country.subscribe(function(e){if(e){var n=t.countries().length;for(var r=0;r<=n;r++)if(e==t.countries()[r].countryCode){t.regions(t.countries()[r].regions);break}}else t.regions([])})},toggleAdvancedSearch:function(){this.isAdvancedSearchEnabled()?this.setAdvancedSearchFlag(!1):this.setAdvancedSearchFlag(!0)},validateStartDate:function(e,t){var n=this;t&&t.value&&t.value.length>0?t.value[0].severity===4?n.isStartDateValid(!1):n.isStartDateValid(!0):n.isStartDateValid(!0)},validateEndDate:function(e,t){var n=this;t&&t.value&&t.value.length>0?t.value[0].severity===4?n.isEndDateValid(!1):n.isEndDateValid(!0):n.isEndDateValid(!0)},getTextSearchCriteria:function(){var e=this,t=e.getBasicSearchCriteria();return t[a.LIMIT]=this.orderSearchViewModel.itemsPerPage,t[a.REQUIRE_COUNT]=!1,t},getBasicSearchCriteria:function(){var e={};this.orderId()&&(e[a.ORDER_ID]=this.orderId()),this.firstName()&&(e[a.PROFILE_FIRST_NAME]=this.firstName()),this.lastName()&&(e[a.PROFILE_LAST_NAME]=this.lastName()),this.accountNameSelected()[0]&&(e[a.ORDER_ACCOUNT]=this.accountNameSelected()[0]),this.approver()&&(e[a.APPROVER]=this.approver()),this.email()&&(e[a.PROFILE_EMAIL]=this.email()),this.selectedSite()&&(e[a.SITE_ID]=this.selectedSite()),this.selectedOrderState()&&(e[a.ORDER_STATE]=this.selectedOrderState()),this.skuId()&&(e[a.SKU_ID]=this.skuId()),this.productId()&&(e[a.PRODUCT_ID]=this.productId());if(this.isTimeSpanEntered()){var t=this.getStartDateFromTimeSpan();t.setHours(0,-t.getTimezoneOffset(),0,0),e[a.ORDER_SEARCH_START_DATE]=t.toISOString()}return this.phone()&&(e[a.ADDRESS_PHONE]=this.phone()),this.isAdvancedSearch()&&(e=this.getAdvancedSearchCriteria(e)),e},getAdvancedSearchCriteria:function(e){var t={},n=this;if(n.startDate()){var r=new Date(n.startDate());isNaN(r)||(r.setHours(0,0,0,0),e[a.ORDER_SEARCH_START_DATE]=r.toISOString())}if(n.endDate()){var i=new Date(n.endDate());isNaN(i)||(i.setHours(23,59,59,0),e[a.ORDER_SEARCH_END_DATE]=i.toISOString())}n.searchType()===n.searchOptions[0]?t=[a.BILLING,a.SHIPPING]:n.searchType()===n.searchOptions[1]?t=[a.BILLING]:n.searchType()===n.searchOptions[2]&&(t=[a.SHIPPING]);var s=[a.ADDRESS_FIRST_NAME,a.ADDRESS_LAST_NAME,a.ADDRESS_ADDRESS_LINE1,a.ADDRESS_ADDRESS_LINE2,a.ADDRESS_CITY,a.ADDRESS_COUNTRY,a.ADDRESS_STATE,a.ADDRESS_POSTAL_CODE],o=[n.billingFirstName(),n.billingLastName(),n.addressLine1(),n.addressLine2(),n.city(),n.country(),n.state(),n.postalCode()],u=s.length;for(var f=0;f<u;f++)if(o[f]){var l=t.length,c="";for(var h=0;h<l;h++)h&&(c+=","),c=c+t[h]+s[f];e[c]=o[f]}return e},resetAdvancedSearchFields:function(){var e=this;e.startDate(""),e.endDate(""),e.searchType(e.resources().advancedSearchBillingAndShipping),e.billingFirstName(""),e.billingLastName(""),e.addressLine1(""),e.addressLine2(""),e.city(""),e.country(""),e.state(""),e.postalCode("")},resetBasicSearch:function(){this.orderId(""),this.email(""),this.firstName(""),this.lastName(""),this.accountNameSelected([]),this.approver(""),this.selectedSite(""),this.selectedOrderState(""),this.timeValueForLastOrders(""),this.timeUnitForLastOrders(this.resources().days),this.skuId(""),this.productId(""),this.phone(""),this.isAdvancedSearch()&&this.resetAdvancedSearchFields(),i.Topic(s.topicNames.SEARCH_RESET).publishWith(this,[]),this.elements["product-search"]&&this.elements["product-search"].resetSearch()},hasAdvancedSearchCriteriaInfo:function(){var e=this;return e.startDate()||!e.isStartDateValid()||!e.isEndDateValid()||e.endDate()||e.billingFirstName()||e.billingLastName()||e.addressLine1()||e.addressLine2()||e.city()||e.country()||e.state()||e.postalCode()?!0:!1},hasBasicCriteriaInfo:function(){return this.firstName()||this.orderId()||this.email()||this.lastName()||this.accountNameSelected()[0]||this.approver()||this.selectedSite()||this.selectedOrderState()||this.timeValueForLastOrders()||this.skuId()||this.productId()||this.phone()?!0:this.isAdvancedSearch()&&this.hasAdvancedSearchCriteriaInfo()?!0:!1},isValid:function(){return!this.isStartDateValid()||!this.isEndDateValid()?!1:this.timeValueForLastOrders.isValid()?!0:!1},setAdvancedSearchFlag:function(e){this.isAdvancedSearch(e)},isAdvancedSearchEnabled:function(){return this.isAdvancedSearch()},getStartDateFromTimeSpan:function(){var e=new Date;return this.timeUnitForLastOrders()===this.timeUnits[0]?e.setDate(e.getDate()-this.timeValueForLastOrders()):this.timeUnitForLastOrders()===this.timeUnits[1]?e.setDate(e.getDate()-7*this.timeValueForLastOrders()):this.timeUnitForLastOrders()===this.timeUnits[2]&&e.setMonth(e.getMonth()-this.timeValueForLastOrders()),e},formatSiteText:function(e){return o.formatSiteText(e)},enableSearchButton:function(){var e=this;return e.hasBasicCriteriaInfo()&&e.isValid()?!0:!1},enableResetButton:function(){var e=this;return e.hasBasicCriteriaInfo()?!0:!1},getSCIMSearchCriteria:function(){var e=this,t={},n={APPROVED:"Approved",PROCESSING:"Being processed",AGENT_REJECTED:"Cancelled by agent",FAILED:"Failed",NO_PENDING_ACTION:"Fulfilled",PENDING_APPROVAL:"Pending approval",PENDING_PAYMENT:"Pending payment",PENDING_REMOVE:"Pending removal",PENDING_CUSTOMER_RETURN:"Pending return from customer",QUOTE_REQUEST_FAILED:"Quote Request failed",FAILED_APPROVAL:"Rejected",REMOVED:"Removed",SUBMITTED:"Submitted to fulfillment",QUOTED:"This order is a quote",REJECTED_QUOTE:"This quote has been rejected",PENDING_QUOTE:"This quote is pending"};return t.q=e.getSCIMBasicSearchCriteria(n),t.queryFormat=a.PARAM_QUERY_FORMAT_SCIM,t.limit=20,t.sort="submittedDate:desc",t.fields="id,priceGroupId,siteId,submittedDate,state,profile,priceInfo,payShippingInSecondaryCurrency,payTaxInSecondaryCurrency,secondaryCurrencyCode,organization",t},getSCIMBasicSearchCriteria:function(e){var t=this,n=[],r,i=[a.SCIM_EMAIL,a.SCIM_ORDER_PHONE_NUMBER,a.SCIM_FIRST_NAME,a.SCIM_LAST_NAME,a.SCIM_ORDER_ID,a.SITE_ID,a.SCIM_PRODUCT_ID,a.SCIM_SKU_ID,a.SCIM_ACCOUNT],s=[t.email(),t.phone(),t.firstName(),t.lastName(),t.orderId(),t.selectedSite(),t.productId(),t.skuId(),t.accountNameSelected()[0]],o=i.length;for(var u=0;u<o;u++)s[u]&&(r=i[u]+a.BLANK_SPACE+'sw "'+s[u]+'"',n.push(r));if(!t.selectedOrderState()){var f=Object.keys(e),l="";f.forEach(function(e,t){var n=a.SCIM_STATUS+a.BLANK_SPACE+'eq "'+e+'"';t?l=l+a.BLANK_SPACE+a.OR_TEXT+a.BLANK_SPACE+n:l=n}),l=a.LEFT_PARENTHISIS+l+a.RIGHT_PARENTHISIS,n.push(l)}else r=a.SCIM_STATUS+a.BLANK_SPACE+'eq "'+t.selectedOrderState()+'"',n.push(r);t.approver()&&(r=a.LEFT_PARENTHISIS+a.SCIM_APPROVER_FIRST_NAME+a.BLANK_SPACE+'sw "'+t.approver()+'"'+a.BLANK_SPACE+a.OR_TEXT+a.BLANK_SPACE+a.SCIM_APPROVER_LAST_NAME+a.BLANK_SPACE+'sw "'+t.approver()+'"'+a.RIGHT_PARENTHISIS,n.push(r));if(t.isTimeSpanEntered()){var c=t.getStartDateFromTimeSpan();c.setHours(0,-c.getTimezoneOffset(),0,0),r=a.SUBMITTED_DATE+a.BLANK_SPACE+'ge "'+c.toISOString()+'"',n.push(r)}t.isAdvancedSearch()&&(n=t.getSCIMAdvancedSearchCriteria(n));var h=t.andBuilder(n);return h},andBuilder:function(e){var t=this,n;return e.forEach(function(e,t){t?n=n+a.BLANK_SPACE+a.AND_TEXT+a.BLANK_SPACE+e:n=e}),n},getSCIMAdvancedSearchCriteria:function(e){var t=this,n=[];if(t.startDate()){var r=new Date(t.startDate());if(!isNaN(r)){r=new Date(r.getTime()+r.getTimezoneOffset()*6e4),r.setHours(0,0,0,0);var i=a.SUBMITTED_DATE+a.BLANK_SPACE+'ge "'+r.toISOString()+'"';e.push(i)}}if(t.endDate()){var s=new Date(t.endDate());if(!isNaN(s)){s=new Date(s.getTime()+s.getTimezoneOffset()*6e4),s.setHours(23,59,59,0);var i=a.SUBMITTED_DATE+a.BLANK_SPACE+'le "'+s.toISOString()+'"';e.push(i)}}t.searchType()===t.searchOptions[0]?n=[a.SHIPPING_GROUPS,a.PAYMENT_GROUPS]:t.searchType()===t.searchOptions[1]?n=[a.PAYMENT_GROUPS]:t.searchType()===t.searchOptions[2]&&(n=[a.SHIPPING_GROUPS]);var o=[a.FIRST_NAME_TEXT,a.LAST_NAME_TEXT,a.ORG_ADDRESS_1,a.ORG_ADDRESS_2,a.ORG_CITY,a.ORG_COUNTRY,a.STATE_ADDRESS,a.ORG_POSTAL_CODE],u=[t.billingFirstName(),t.billingLastName(),t.addressLine1(),t.addressLine2(),t.city(),t.country(),t.state(),t.postalCode()],f=o.length;for(var l=0;l<f;l++)if(u[l]){var c="";n.forEach(function(e,t){var n=e+"."+o[l]+a.BLANK_SPACE+'sw "'+u[l]+'"';t?c=c+a.BLANK_SPACE+a.OR_TEXT+a.BLANK_SPACE+n:c=n}),c=a.LEFT_PARENTHISIS+c+a.RIGHT_PARENTHISIS,e.push(c)}return e},productSearchSuccessCallback:function(e){var t=this;t.productId(e),this.enableSearchButton()},isSiteExists:function(e){return o.doesSiteExist(e.siteId)},clickOrderDetails:function(e,t){var n=this;e.profile&&e.profile.firstName&&u.getInstance().setShopperProfileId(e.profile.profileId);var r=e.siteId;return u.getInstance().setSelectedSite(r),n.user().navigateToPage(this.links().AgentOrderDetails.route+"/"+t),!1},translateOrderStates:function(e){var t=this,n=t.translate(e);return e==a.QUEUED_ORDER_KEY&&(n=n+" ("+e+")"),n},getStateLabel:function(e){return e==a.QUEUED_ORDER_KEY?p.t("ns.common:resources."+e)+" ("+e+")":p.t("ns.common:resources."+e)}}})