define(["knockout","pubsub","notifier","spinner","CCi18n","jquery","ccRestClient","ccDate","ccConstants","navigation","pageLayout/currency","viewModels/site-listing","agentViewModels/orderDetailsWrapperViewModel","agentViewModels/comments","agentViewModels/agent-context-manager","pageLayout/site","agentViewModels/agentUtils/cpq-childItems-utils","pageLayout/scheduled-order","pageLayout/product","viewModels/dynamicPropertyMetaContainer","viewModels/address","agentViewModels/country-region-data","agentViewModels/account-site-selector","productDetailsUtils","agentViewModels/agentUtils/agent-utils"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T){"use strict";return{WIDGET_ID:"ultraSourceOrderDetailsAgent",CCConstants:a,coupons:e.observableArray([]),orderDetails:e.observable(),isExchangeOrder:e.observable(!1),exchangePaymentInfo:e.observable(),couponMultiPromotions:e.observableArray([]),originalOrderId:e.observable(),orderApproverName:e.observable(""),authorizedGiftCards:e.observableArray([]),authorizedCreditCards:e.observableArray([]),authorizedInvoicePayments:e.observableArray([]),cashPaymentDetails:e.observableArray([]),authorizedVirtualPayments:e.observableArray([]),authorizedStoreCreditPayments:e.observableArray([]),paymentDue:e.observable(),orderDetailsWrapper:e.observable(),orderSite:e.observable(null),contextManager:d,selectedCartItemsOfPurchaseList:e.observableArray([]),allCartItemsArray:[],cartItemsSelectedArray:e.observableArray([]),selectedProduct:e.observableArray([]),selectedOrder:e.observable(),approverComments:e.observable(""),shoppingCartDetails:e.observableArray([]),selectedShippingGroupForTracking:e.observable(0),currencySymbol:"",isAgentApplication:!1,scheduledOrderIndicator:"#main",scheduledOrderIndicatorOptions:{parent:"#main",posTop:"20em",posLeft:"50%"},orderRefreshIndicator:"#main",orderRefreshIndicatorOptions:{parent:"#main",posTop:"20em",posLeft:"50%"},scheduledOrder:e.observable(),display:e.observable(!1),isOwner:e.observable(!0),isBackLinkAvailable:e.observable(!1),opDynamicProperty:e.observable(),date_regex:/^(0[1-9]|1[0-2])\/(0[1-9]|1\d|2\d|3[01])\/(19|20|21)\d{2}$/,onLoad:function(n){n.CCi18n=i,n.isAgentApplication=window.isAgentApplication,n.opDynamicProperty(a.DYNAMIC_PROPERTY_VIEW_ONLY);var o=e.observable(!1),u=e.observable(!1),f=e.observable(!1);n.modalObject=e.observable(null),n.dynamicProperties=e.observableArray([]),n.dynamicPropertiesLoaded=s.Deferred(),n.dynamicPropertyMetaInfo=b.getInstance(),n.orderDetailsWrapper=h.getInstance();if(!n.orderDetailsWrapper.orderDetails()||n.orderDetailsWrapper.orderDetails()&&!n.orderDetailsWrapper.orderDetails().id){var l=n.cart().currentOrderId(),c=null;l&&(c={}),n.orderDetailsWrapper=h.getInstance(c,l)}n.orderDetails(n.orderDetailsWrapper.orderDetails()),n.getAddressDynamicPropertiesMetaDataSuccessCallback=function(e){n.dynamicPropertyMetaInfo.intializeDynamicProperties(e.specifications,a.ENDPOINT_CONTACT_INFO_TYPE),n.dynamicPropertiesLoaded.resolve()},n.getAddressDynamicPropertiesMetaDataFailureCallback=function(e){n.dynamicPropertiesLoaded.resolve()},n.showSwitchOrganizationModal=function(){n.display(!1),o(!0),s("#CC-scheduleOrderDetails-modal").modal("show"),s("#CC-scheduleOrderDetails-modal").on("hidden.bs.modal",function(){!f()&&!u()&&o()&&s("#CC-scheduleOrderDetailsContextChangeMsg").show()})},n.checkIfExchangeEnabled=function(){return n.isExchangeEnabled&&n.orderDetailsWrapper.isExchangeOrder()||n.orderDetailsWrapper.orderDetails().state===a.ORDER_STATE_NO_PENDING_ACTION},n.checkIfReturnEnabled=function(){return n.orderDetailsWrapper.isReturnOrder()||n.orderDetailsWrapper.orderDetails().state===a.ORDER_STATE_NO_PENDING_ACTION},s.Topic(t.topicNames.REREQUEST_REJECT_QUOTE_ORDER_SUCCESS).subscribe(function(e){n.invalidateOrder(e)}),n.scheduledOrder(g.getInstance()),n.display(!1),n.saveScheduledOrderSuccess=n.saveScheduledOrderSuccess.bind(n),n.saveScheduledOrderError=n.saveScheduledOrderError.bind(n),n.deleteScheduledOrderSuccess=n.deleteScheduledOrderSuccess.bind(n),n.deleteScheduledOrderError=n.deleteScheduledOrderError.bind(n),n.suspended=e.pureComputed({read:n.isSuspended,write:n.setSuspended},n),n.parsedStartDate=e.pureComputed({read:n.getStartDate,write:n.setStartDate},n),n.parsedEndDate=e.pureComputed({read:n.getEndDate,write:n.setEndDate},n),n.scheduledOrder().name.extend({required:{params:!0,message:n.translate("nameRequired")},maxLength:{params:a.REPOSITORY_STRING_MAX_LENGTH,message:n.translate("maxlengthValidationMsg",{fieldName:n.translate("nameText"),maxLength:a.REPOSITORY_STRING_MAX_LENGTH})}}),n.scheduledOrder().startDate.extend({required:{params:!0,message:n.translate("startDateRequired")}}),n.scheduledOrder().endDate.extend({validation:[{validator:function(e){var t=new Date(e),r=new Date(n.scheduledOrder().startDate());return r<t},message:n.translate("endDateGreaterThanStartDateText"),onlyIf:function(){return n.scheduledOrder().endDate()}}]}),s.Topic(t.topicNames.REREQUEST_REJECT_QUOTE_ORDER_SUCCESS).subscribe(function(e){n.invalidateOrder(e)}),n.scheduledOrder().daysOfWeek.extend({validation:[{validator:function(e,t){return e.length>=t},message:n.translate("daysOfWeekRequired"),params:1,onlyIf:function(){return n.isDaysOfWeekEnabled()}}]}),n.scheduledOrder().weeksInMonth.extend({validation:[{validator:function(e,t){return e.length>=t},message:n.translate("weeksInMonthRequired"),params:1,onlyIf:function(){return n.isWeeksInMonthEnabled()}}]}),n.validationModel=e.validatedObservable({name:n.scheduledOrder().name,startDate:n.scheduledOrder().startDate,endDate:n.scheduledOrder().endDate,daysOfWeek:n.scheduledOrder().daysOfWeek,weeksInMonth:n.scheduledOrder().weeksInMonth}),n.scheduleModeOptGroups=[{label:n.translate("daily"),options:[{text:n.translate("onceADay"),value:a.SCHEDULE_MODE_ONCE_DAILY}]},{label:n.translate("weekly"),options:[{text:n.translate("weekly"),value:a.SCHEDULE_MODE_WEEKLY}]},{label:n.translate("monthly"),options:[{text:n.translate("onceAMonth"),value:a.SCHEDULE_MODE_ONCE_MONTHLY},{text:n.translate("everyTwoMonths"),value:a.SCHEDULE_MODE_BI_MONTHLY},{text:n.translate("quarterly"),value:a.SCHEDULE_MODE_QUARTERLY}]}],n.isOwner=e.computed(function(){return n.user()&&n.scheduledOrder()&&n.user().id()==n.scheduledOrder().profileId()?!n.scheduledOrder().templateOrder()||n.scheduledOrder().templateOrder().state!==a.PENDING_SCHEDULED_ORDER_APPROVAL&&n.scheduledOrder().templateOrder().state!==a.SCHEDULED_ORDER_STATE_REJECTED?!0:!1:!1}),n.setRenderedCompleteToTrue=function(e){e&&(d.getInstance().setSelectedSite(null),n.orderDetailsWrapper.isRenderComplete(!0))},n.orderDetailsWrapper.isValidActionEndpointFailure()&&n.setRenderedCompleteToTrue(!0),d.getInstance().getShopperProfileId()&&!n.user().id()&&n.user().id(d.getInstance().getShopperProfileId()),n.orderDetailsWrapper.isValidActionEndpointFailure.subscribe(n.setRenderedCompleteToTrue.bind(n)),n.isEligibleToCompletePayment=e.computed(function(){if(n.user()&&n.scheduledOrder()&&n.scheduledOrder().profileId()&&n.user().id()===n.scheduledOrder().profileId()&&n.orderApproverName()!=null&&n.scheduledOrder().templateOrder()&&n.scheduledOrder().templateOrder().state===a.PENDING_PAYMENT_TEMPLATE){var e=n.scheduledOrder().templateOrder().paymentGroups?n.scheduledOrder().templateOrder().paymentGroups:n.scheduledOrder().templateOrder().payments,t=0,r=!1;for(var i=0;i<e.length;i++){e[i].paymentMethod!=a.GIFT_CARD_PAYMENT_TYPE&&(t+=e[i].amount);if(e[i].paymentState===a.PAYMENT_GROUP_STATE_AUTHORIZED_FAILED||e[i].paymentState===a.PAYMENT_GROUP_STATE_PAYMENT_REQUEST_FAILED)r=!0}if(t>0||r===!0||e.length===0)return!0}return!1},n),n.destroySpinner=function(e){s(e).removeClass("loadingIndicator"),r.destroyWithoutDelay(e)},n.createSpinner=function(e,t){s(e).css("position","relative"),s(e).addClass("loadingIndicator"),r.create(t)},n.detailsLinkWithLocale=function(e){return n.isAgentApplication?n.user().navigateToPage(this.links().AgentOrderDetails.route+"/"+e):n.user().navigateToPage("/orderDetails//"+e)},n.profileDetailsLinkWithLocale=function(){if(n.isAgentApplication){var e=n.user().id;n.user().id!=n.orderDetailsWrapper.orderDetails().profileId&&(e=n.orderDetailsWrapper.orderDetails().profileId,d.getInstance().setShopperProfileId(e)),S.clearOrganizationDetails(),n.user().navigateToPage(n.links().agentCustomerDetails.route+"?customerId="+e)}else n.user().validateAndRedirectPage(n.links().profile.route)}},beforeAppear:function(r){var i=this,o="";i.scheduledOrderCreatedSuccess=function(){d.getInstance().setProperty(a.AGENT_PARAM_IS_SCHEDULED_ORDER,!0),r.contextId?o=r.contextId:o=r.path.split("/")[1];var e=i.links().AgentOrderDetails.route;i.user().validateAndRedirectPage(e+"/"+o+"?isScheduledOrder=true")},s.Topic(t.topicNames.SCHEDULED_ORDER_SUBMISSION_SUCCESS).subscribe(i.scheduledOrderCreatedSuccess.bind(i)),i.scheduledOrder().reset(),i.isBackLinkAvailable(!0),!i.isPreview()&&!i.historyStack.length&&this.isBackLinkAvailable(!1);if(!i.orderDetailsWrapper.orderDetails()){var u={},l=i.cart().currentOrderId();i.orderDetailsWrapper=h.getInstance(u,l)}if(i.orderDetailsWrapper.orderDetails()&&!i.orderDetailsWrapper.orderDetails().id&&f.getQueryString()&&f.getQueryString().indexOf(a.ORDER_PENDING_PAYMENT)>-1||!i.orderDetailsWrapper.orderDetails()){var l,c={};f.getQueryString()&&f.getQueryString().indexOf(a.ORDER_PENDING_PAYMENT)>-1?(l=T.getUrlParamValue(r.parameters,a.ORDER_ID),i.cart().currentOrderState(a.PENDING_PAYMENT),i.cart().currentOrderId(l)):l=i.cart().currentOrderId(),i.orderDetailsWrapper=h.getInstance(c,l)}i.orderDetails(i.orderDetailsWrapper.orderDetails());var p=[];i.orderDetails&&i.orderDetails()&&i.orderDetails().order&&(p=i.orderDetails().order.items),i.orderDetailsWrapper.isRenderComplete.subscribe(function(e){e&&i.orderDetailsWrapper.orderDetails().id?i.populateOrderDetails():(i.coupons([]),i.orderDetails(null),i.isExchangeOrder(!1),i.exchangePaymentInfo(null),i.couponMultiPromotions([]),i.originalOrderId(null),i.orderApproverName(""),i.authorizedGiftCards([]),i.authorizedCreditCards([]),i.authorizedInvoicePayments([]),i.cashPaymentDetails([]),i.authorizedVirtualPayments([]),i.authorizedStoreCreditPayments([]),i.paymentDue(null),i.orderDetailsWrapper.isPayShippingInSecondaryCurrency(!1),i.orderDetailsWrapper.isPayTaxInSecondaryCurrency(!1),i.orderDetailsWrapper.isMultiCurrencyOrder(!1),i.orderSite(null),i.selectedCartItemsOfPurchaseList([]),i.allCartItemsArray=[],i.cartItemsSelectedArray([]),i.selectedProduct([]),i.selectedOrder(null),d.getInstance().setProperty(a.AGENT_PARAM_IS_SCHEDULED_ORDER,!1),i.orderDetailsWrapper.cacheHandler.addItemToCache(a.SHOW_SCHEDULED_ORDER,!1),i.display(!1))}),i.loadTemplate=function(){!i.contextManager.getInstance().getShopperProfileId()&&i.scheduledOrder().profileId()&&i.user().id(i.scheduledOrder().profileId()),i.validationModel.errors.showAllMessages(!1),i.destroySpinner(i.scheduledOrderBodyIndicator),i.user().currentOrganization()&&i.scheduledOrder().organizationId()!=(typeof i.user().currentOrganization().repositoryId==="function"?i.user().currentOrganization().repositoryId():i.user().currentOrganization().repositoryId)?(i.showSwitchOrganizationModal(),i.display(!1)):i.display(!0),this.message&&(n.clearError(i.WIDGET_ID),n.clearSuccess(i.WIDGET_ID),n.sendError(i.WIDGET_ID,this.message,!0)),i.registerDatepickerEvents()},i.loadErrorTemplate=function(){i.validationModel.errors.showAllMessages(!1),i.destroySpinner(i.scheduledOrderBodyIndicator),n.clearError(i.WIDGET_ID),n.clearSuccess(i.WIDGET_ID),n.sendError(i.WIDGET_ID,this.message,!0),s.Topic(t.topicNames.SCHEDULED_ORDER_LOAD_ERROR).unsubscribe(i.loadErrorTemplate)},s.Topic(t.topicNames.SCHEDULED_ORDER_LOAD_SUCCESS_AGENT).subscribe(i.loadTemplate),i.selectedProduct([]);var l=r.contextId,v=function(t){t.childItems[n].expanded=e.observable(!1);for(var n=0;n<t.childItems.length;n++)t.childItems[n].childItems&&t.childItems[n].childItems.length>0&&v(t.childItems[n])};for(var m=0;p&&m<p.length;m++){var g=p[m];g.childItems&&g.childItems.length>0&&v(g)}d.getInstance().getShopperProfileId();if(r.parameters&&r.parameters==="isScheduledOrder=true"||d.getInstance().getProperty(a.AGENT_PARAM_IS_SCHEDULED_ORDER)||i.orderDetailsWrapper.cacheHandler.getItemFromCache(a.SHOW_SCHEDULED_ORDER).result)r.contextId?o=r.contextId:o=r.path.split("/")[1],i.scheduledOrder().load(o.trim())},redirectToListingPage:function(){var e=this;e.closeModalById("#cc-cancel-scheduleOrder-ModalContainer"),e.isAgentApplication?e.redirectToScheduleOrderPage(this.links().agentScheduledOrder.route):e.user().validateAndRedirectPage(e.links().profile.route)},closeModalById:function(e){s(e).modal("hide"),s("body").removeClass("modal-open"),s(".modal-backdrop").remove()},populateOrderDetails:function(){var t=this,n=t.orderDetailsWrapper.orderDetails();this.user().id()&&!n.profile.isAnonymous?t.contextManager.getInstance().setShopperProfileId(this.user().id()):n.profileId&&!n.profile.isAnonymous&&t.contextManager.getInstance().setShopperProfileId(n.profileId);if(n.hasOwnProperty("approvers")&&n.approvers[0]){var r=n.approvers[0].firstName+" "+n.approvers[0].lastName;t.orderApproverName(r)}if(n.approverMessages&&n.approverMessages.length!=0){var i=t.orderApproverName()?t.orderApproverName()+": "+n.approverMessages:n.approverMessages;t.approverComments(i)}n.originalOrderId&&(t.exchangePaymentInfo(n.returnRequestData),t.originalOrderId(n.originalOrderId),t.isExchangeOrder(!0));if(n.priceListGroup)t.currencySymbol=n.priceListGroup.currency.symbol,o.setStoredValue(a.LOCAL_STORAGE_PRICELISTGROUP_ID,e.toJSON(n.priceListGroup.id));else{var s={currency:currencyHelper.currencyObject()};self.currencySymbol=s.currency.symbol,n.priceListGroup=s}t.populatePromotionData(),t.orderSite(n.siteId),t.populatePaymentData();for(var u in n.shippingGroups)for(var f in n.shippingGroups[u].items)n.shippingGroups[u].items[f].isPriceOverridden&&(n.shippingGroups[u].items[f].priceOverrideReasonText=t.translate("priceOverrideReasonText"),n.shippingGroups[u].items[f].priceOverridenByText=t.translate("priceOverridenByText"),n.shippingGroups[u].items[f].priceOverrideHeaderText=t.translate("priceOverrideHeaderText")),m.allowChildItemsToBeExpanded(n.shippingGroups[u].items[f].childItems)},displayPriceOverrideProperties:function(e){var t=this;return e.isPriceOverridden?(e.priceOverrideReasonText=t.translate("priceOverrideReasonText"),e.priceOverridenByText=t.translate("priceOverridenByText"),e.priceOverrideHeaderText=t.translate("priceOverrideHeaderText"),!0):!1},loadOrderNotes:function(){var e=this,t=e.orderDetailsWrapper.orderDetails();if(e.elements.hasOwnProperty("agent-notes")){var n=e.elements["agent-notes"];t.id&&n.initialiseCommentsViewModel("order",t.id,t.orderComments)}return!0},populatePromotionData:function(){var e=this,t=e.orderDetailsWrapper.orderDetails();e.couponMultiPromotions().length&&e.couponMultiPromotions.removeAll(),e.coupons().length&&e.coupons.removeAll();if(t.discountInfo){var n=t.discountInfo.claimedCouponMultiPromotions,r=t.discountInfo.orderCouponsMap,i=[];if(n)for(var s in n)n.hasOwnProperty(s)&&(n[s].code=s,e.couponMultiPromotions.push(n[s]));if(r)for(var o in r)r.hasOwnProperty(s)&&i.indexOf(s)<0&&(r[s].code=s,e.coupons.push(r[s]))}},populatePaymentData:function(){var e=this,t=e.orderDetailsWrapper.orderDetails(),n=t.hasOwnProperty("stateString")?t.stateString:t.state;if(n===a.ORDER_STATE_PENDING_PAYMENT){var r=e.orderDetailsWrapper.orderDetails().priceInfo.total-e.orderDetailsWrapper.orderDetails().totalAmountAuthorized;e.paymentDue(r)}e.authorizedCreditCards().length&&e.authorizedCreditCards.removeAll(),e.authorizedGiftCards().length&&e.authorizedGiftCards.removeAll(),e.authorizedInvoicePayments().length&&e.authorizedInvoicePayments.removeAll(),e.cashPaymentDetails().length&&e.cashPaymentDetails.removeAll(),e.authorizedVirtualPayments().length&&e.authorizedVirtualPayments.removeAll(),e.authorizedStoreCreditPayments().length&&e.authorizedStoreCreditPayments.removeAll();var i=t.paymentGroups?t.paymentGroups:t.payments,s=i.length;for(var o=0;o<s;o++)i[o].paymentState==a.PAYMENT_STATE_AUTHORIZED||i[o].paymentState==a.PAYMENT_STATE_SETTLED||i[o].paymentState==a.PAYMENT_STATE_PENDING_AUTHORIZATION?i[o].cardType===a.GIFT_CARD_PAYMENT_TYPE?e.authorizedGiftCards.push(i[o]):i[o].paymentType===a.LOYALTY_POINTS_PAYMENT_TYPE?e.authorizedVirtualPayments.push(i[o]):i[o].type===a.INVOICE_PAYMENT_TYPE?e.authorizedInvoicePayments.push(i[o]):i[o].type===a.CASH_PAYMENT_TYPE?e.cashPaymentDetails.push(i[o]):i[o].type===a.STORE_CREDIT_PAYMENT_TYPE?e.authorizedStoreCreditPayments.push(i[o]):e.authorizedCreditCards.push(i[o]):i[o].paymentState===a.PAYMENT_STATE_PAYMENT_DEFERRED&&i[o].type===a.INVOICE_PAYMENT_TYPE?e.authorizedInvoicePayments.push(i[o]):i[o].paymentState===a.PAYMENT_STATE_PAYMENT_REQUEST_ACCEPTED&&i[o].type===a.CASH_PAYMENT_TYPE?e.cashPaymentDetails.push(i[o]):i[o].paymentState===a.PAYMENT_STATE_INITIAL&&n!==a.REMOVED&&(e.verifyApprovalOrderStates(n)||t.scheduledOrderId)&&(i[o].type===a.INVOICE_PAYMENT_TYPE?e.authorizedInvoicePayments.push(i[o]):i[o].type===a.CASH_PAYMENT_TYPE&&e.cashPaymentDetails.push(i[o]))},getSecondaryCurrency:function(e){if(e){var t=l.getInstance();if(t){var n=t.currencyMap[e];return n}}},isSubmittedDate:function(){return this.orderDetailsWrapper.orderDetails().hasOwnProperty("submittedDate")&&this.orderDetailsWrapper.orderDetails().submittedDate},showApprovalDetails:function(e){var t=this;e.approvers&&e.approvers[0]&&t.orderApproverName(e.approvers[0].firstName+" "+e.approvers[0].lastName);if(e.approverMessages&&e.approverMessages.length!=0){var n=t.orderApproverName()?t.orderApproverName()+": "+e.approverMessages:e.approverMessages;t.approverComments(n)}return t.orderApproverName()&&t.approverComments()&&e.stateString!=a.PENDING_APPROVAL_TEMPLATE&&a.PENDING_APPROVAL!=e.stateString&&this.orderDetailsWrapper.orderDetails()},totalItemsLength:function(){var e=this,t=0;if(e.orderDetailsWrapper.orderDetails().id){var n=e.orderDetailsWrapper.orderDetails().shippingGroups,r=n.length;for(var i=0;i<r;i++){var s=n[i].items,o=s.length;t+=o}}return t},formatSiteText:function(e){var t=this;if(e){var n=c.sites(),r=c.getSiteDetails(e,n),i=c.formatSiteText(r);return i}},localeTextForShippingAndTaxTotal:function(){var e=this,t=e.translate("shippingCostText"),n=e.translate("salesTaxText"),r=e.translate("shippingAndTaxText",{shippingText:t,taxText:n});return r},showStrikeThroughForItemSub:function(e){return e.onSale||e.discountInfo&&e.discountInfo.length>0||e.isPriceOverridden},verifyApprovalOrderStates:function(e){var t=this,n=[a.PENDING_APPROVAL,a.PENDING_APPROVAL_TEMPLATE,a.FAILED_APPROVAL];return n.indexOf(e)>-1?!0:!1},showPaymentDetails:function(){var e=this,t=e.orderDetailsWrapper.orderDetails().hasOwnProperty("stateString")?e.orderDetailsWrapper.orderDetails().stateString:e.orderDetailsWrapper.orderDetails().state,n=!0;return e.verifyApprovalOrderStates(t)&&!e.authorizedInvoicePayments().length&&!e.cashPaymentDetails().length?n=!1:e.populatePaymentData(),n},getCityStatePostal:function(e){var t="";return e?(e.hasOwnProperty("city")&&e.city&&(t+=e.city+", "),e.hasOwnProperty("stateName")&&e.stateName?t+=e.stateName+", ":e.hasOwnProperty("state")&&e.state&&(t+=e.state+", "),e.hasOwnProperty("postalCode")&&e.postalCode&&(t+=e.postalCode),t):t},getCountryName:function(e){var t="";return e?e.hasOwnProperty("countryName")&&e.countryName?e.countryName:e.hasOwnProperty("country")&&e.country?e.country:t:t},getSelectedProducts:function(){var e=this,t=[],n=e.orderDetailsWrapper.orderDetails().shippingGroups;return n.forEach(function(e){e.items.forEach(function(n){var r=e.shippingGroupId+":"+(n.commerceItemId?n.commerceItemId:n.commerceId?n.commerceId:"");if(e.selectedProduct.indexOf(r)!=-1){var i={productId:n.productId,catRefId:n.catRefId,quantityDesired:n.quantity,displayName:n.displayName};t.push(i)}})}),t},isInDialog:function(){return s("#CC-prodDetails-addToCart").closest(".modal").length},agentCopyOrder:function(){var e=this;e.orderDetailsWrapper.orderDetails().profile.isAnonymous?(this.destroySpinner(this.orderRefreshIndicator),n.clearError(e.WIDGET_ID),n.clearSuccess(e.WIDGET_ID),n.sendError(this.WIDGET_ID,this.translate("copyOrderAnonymousUser"),!0)):(this.createSpinner(this.orderRefreshIndicator,this.orderRefreshIndicatorOptions),e.orderDetailsWrapper.hasIncompleteOrder()?e.orderDetailsWrapper.agentCopyOrder(e.orderDetailsWrapper.orderDetails().id,e.copyOrderSuccess.bind(e),e.copyOrderFailure.bind(e)):e.orderDetailsWrapper.checkForIncompleteOrder(e.orderDetailsWrapper.orderDetails().id,e.checkForIncompleteOrderSuccess.bind(e),e.checkForIncompleteOrderFailure.bind(e)))},copyOrderSuccess:function(){var e=this;return this.destroySpinner(this.orderRefreshIndicator),this.user().navigateToPage(this.links().agentCheckout.route),!1},copyOrderFailure:function(e){var t=this;this.destroySpinner(this.orderRefreshIndicator),n.clearError(t.WIDGET_ID),n.clearSuccess(t.WIDGET_ID);var r=this.translate("copyOrderFailedError");e&&e.message&&(r=r+":"+e.message),n.sendError(this.WIDGET_ID,r,!0)},checkForIncompleteOrderSuccess:function(){var e=this;return e.orderDetailsWrapper.hasIncompleteOrder()?(this.destroySpinner(this.orderRefreshIndicator),s("#cc-copyOrder-modal-agent").modal("show")):e.orderDetailsWrapper.agentCopyOrder(e.orderDetailsWrapper.orderDetails().id,e.copyOrderSuccess.bind(e),e.copyOrderFailure.bind(e)),!1},checkForIncompleteOrderFailure:function(e){var t=this;this.destroySpinner(this.orderRefreshIndicator),n.clearError(t.WIDGET_ID),n.clearSuccess(t.WIDGET_ID);var r=this.translate("copyOrderFailedError");e&&e.message&&(r=r+":"+e.message),n.sendError(this.WIDGET_ID,r,!0)},setSelectedOrder:function(e,t){this.selectedOrder(e.order)},showPromotionDetails:function(){var e=this,t=!0;return e.orderDetailsWrapper.orderDetails().id?(t=!0,e.populatePromotionData()):t=!1,t},orderRefresh:function(){var e=this;this.createSpinner(this.orderRefreshIndicator,this.orderRefreshIndicatorOptions);var t={};t.isCallFromRefresh=!0,e.orderDetailsWrapper.isRenderComplete(!1),e.orderDetailsWrapper.invalidateOrder(t,e.invalidateOrderSuccess.bind(e),e.invalidateOrderFailure.bind(e))},invalidateOrderSuccess:function(e,t){var r=this;r.reset();var i=r.orderDetailsWrapper.scheduledOrderDetails();if(i){var s=i.id;r.scheduledOrder().load(s)}else r.orderDetailsWrapper.populateOrderDetails({},r.orderDetailsWrapper.orderDetails().id);this.destroySpinner(this.orderRefreshIndicator),e.hasOwnProperty("isCallFromRejectQuoteButton")&&e.isCallFromRejectQuoteButton?n.sendSuccess(r.WIDGET_ID,r.translate("rejectQuoteOrderSuccessMessage")):e.hasOwnProperty("isCallFromReRequestButton")&&e.isCallFromReRequestButton?n.sendSuccess(r.WIDGET_ID,r.translate("reRequestQuoteOrderSuccessMessage")):n.sendSuccess(r.WIDGET_ID,r.translate("invalidateOrderSuccessMessage"))},invalidateOrderFailure:function(e){var t=this;t.destroySpinner(t.orderRefreshIndicator),n.clearError(t.WIDGET_ID),n.clearSuccess(t.WIDGET_ID),t.orderDetailsWrapper.isRenderComplete(!0);var r=t.translate("invalidateOrderErrorHeader");e&&e.message&&(r=r+" : "+e.message),n.sendError(t.WIDGET_ID,r,!0),s("#cc-orderDetails-sendEmailNotification-btn").focus()},reset:function(e){this.coupons([]),this.orderDetails(null),this.isExchangeOrder(!1),this.exchangePaymentInfo(null),this.couponMultiPromotions([]),this.originalOrderId(null),this.orderApproverName(null),this.authorizedGiftCards([]),this.authorizedCreditCards([]),this.authorizedInvoicePayments([]),this.cashPaymentDetails([]),this.authorizedVirtualPayments([]),this.authorizedStoreCreditPayments([]),this.paymentDue(null),this.orderDetailsWrapper.isPayShippingInSecondaryCurrency(!1),this.orderDetailsWrapper.isPayTaxInSecondaryCurrency(!1),this.orderDetailsWrapper.isMultiCurrencyOrder(!1),this.orderSite(null),this.selectedCartItemsOfPurchaseList([]),this.cartItemsSelectedArray([]),d.getInstance().setProperty(a.AGENT_PARAM_IS_SCHEDULED_ORDER,!1),this.orderDetailsWrapper.cacheHandler.addItemToCache(a.SHOW_SCHEDULED_ORDER,!1),this.orderDetailsWrapper.hasIncompleteOrder(!1),this.display(!1)},sendPlacedOrderEmailNotification:function(){var e=this,t={};t[a.OP]=a.SEND_PLACED_ORDER_EMAIL_NOTIFICATION,o.request(a.ENDPOINT_HANDLE_ORDER_ACTIONS,t,function(t){n.sendSuccess(e.WIDGET_ID,e.translate("sentEmailNotificationSuccess"))},function(e){n.clearError(this.WIDGET_ID),n.clearSuccess(this.WIDGET_ID),n.sendError(this.WIDGET_ID,this.translate("sentEmailNotificationFailure"),!0)},e.orderDetailsWrapper.orderDetails().id)},toggleExpandedFlag:function(e){e.expanded()?e.expanded(!1):e.expanded(!0)},registerDatepickerEvents:function(){var e="#CC-scheduledOrder-startDate",t="#CC-scheduledOrder-endDate",n=this;s(e).on("keyup",function(t){var r=t.which?t.which:t.keyCode;r===a.KEY_CODE_ENTER&&s(e).datepicker("hide"),s(e).off("blur").on("blur",function(t){var r=n.setDefaultDate(e);n.scheduledOrder().startDate(r);var i=n.date_regex.test(r);i||(s("#CC-scheduledOrder-startDate-error.text-danger")[0].style="",s("#CC-scheduledOrder-startDate-error.text-danger")[0].innerText=n.translate("startDateRequired")),s(e).off("blur")})}),s(t).on("keyup",function(r){var i=r.which?r.which:r.keyCode;i===a.KEY_CODE_ENTER&&s(e).datepicker("hide"),s(t).off("blur").on("blur",function(e){var r=n.setDefaultDate(t);n.scheduledOrder().endDate(r);var i=n.date_regex.test(r);!i&&r?(s("#CC-scheduledOrder-endDate-error.text-danger")[0].style="",s("#CC-scheduledOrder-endDate-error.text-danger")[0].innerText=n.translate("endDateRequired")):r<=n.scheduledOrder().endDate()?(s("#CC-scheduledOrder-endDate-error.text-danger")[0].style="",s("#CC-scheduledOrder-endDate-error.text-danger")[0].innerText=n.translate("endDateGreaterThanStartDateText")):s("#CC-scheduledOrder-endDate-error.text-danger")[0].innerText="",s(t).off("blur")})})},onClickChildItems:function(e,t){var n=this,r={productId:e.productId,externalPrice:e.externalPrice,quantity:e.quantity},i={};i[a.PRICE_LIST_GROUP_ID]=n.site().selectedPriceListGroup().id,n.getProductData(i,r,t)},setDefaultDate:function(e){var t=this;if(e){var n=s(e).val(),r=new Date(n),i=new Date,o=t.date_regex.test(n);return o?(r<=i&&(i.setDate(i.getDate()+1),r=i),r!="Invalid Date"?(r=u.dateTimeFormatter(r,null,"short"),s(e).datepicker("update",r).datepicker("fill")):r="",r):n}},isSuspended:function(){return this.scheduledOrder().state()===a.SCHEDULED_ORDER_STATE_INACTIVE},setSuspended:function(e){e===!0?this.scheduledOrder().state(a.SCHEDULED_ORDER_STATE_INACTIVE):this.scheduledOrder().state(a.SCHEDULED_ORDER_STATE_ACTIVE)},getStartDate:function(){var e=this.scheduledOrder().startDate();return e?u.dateTimeFormatter(e,null,"short"):""},setStartDate:function(e){this.scheduledOrder().startDate(e)},getEndDate:function(){var e=this.scheduledOrder().endDate();return e?u.dateTimeFormatter(e,null,"short"):""},setEndDate:function(e){this.scheduledOrder().endDate(e)},isDaysOfWeekEnabled:function(){var e=this.scheduledOrder().scheduleMode(),t=e===a.SCHEDULE_MODE_WEEKLY;return t},daysOfWeekEnabled:function(){return e.pureComputed(this.isDaysOfWeekEnabled,this)},isWeeksInMonthEnabled:function(){var e=this.scheduledOrder().scheduleMode(),t=e===a.SCHEDULE_MODE_WEEKLY;return t},weeksInMonthEnabled:function(){return e.pureComputed(this.isWeeksInMonthEnabled,this)},isWeeksInMonthReadonly:function(e){var t=this.scheduledOrder(),n=t.scheduleMode(),r=t.weeksInMonth(),i=t.daysOfWeek(),s=n===a.SCHEDULE_MODE_WEEKLY&&r.length===4&&i.length===7&&!e.checked;return s},weeksInMonthReadonly:function(e){return!1},closeScheduledOrder:function(){var e=this;this.scheduledOrder().dirtyFlag.isDirty()?(s("#cc-cancel-scheduleOrder-ModalContainer").one("show.bs.modal",function(){s("#cc-cancel-scheduleOrder-ModalPane").show()}),s("#cc-cancel-scheduleOrder-ModalContainer").one("hide.bs.modal",function(){s("#cc-cancel-scheduleOrder-ModalPane").hide()}),s("#cc-cancel-scheduleOrder-ModalContainer").modal("show")):e.browserBack()},browserBack:function(){var e=this;e.isBackLinkAvailable()?window.history.go(-1):e.isAgentApplication?e.user().navigateToPage(this.links().agentScheduledOrder.route):f.goTo(e.links().profile.route)},clickOrderDetails:function(e){var t=this;return t.user().navigateToPage(this.links().AgentOrderDetails.route+"/"+e),!1},showReturnRequest:function(e,t){var n=this;n.user().navigateToPage(this.links().agentViewReturnRequest.route+"?returnRequestId="+e+"&orderId="+t)},saveScheduledOrder:function(){this.validationModel.isValid()?(this.createSpinner(this.scheduledOrderIndicator,this.scheduledOrderIndicatorOptions),this.scheduledOrder().save(this.saveScheduledOrderSuccess,this.saveScheduledOrderError)):(this.validationModel.errors.showAllMessages(),n.clearError(this.WIDGET_ID),n.clearSuccess(this.WIDGET_ID),n.sendError(this.WIDGET_ID,this.translate("validationModalErrorMessage"),!0))},saveScheduledOrderSuccess:function(){this.destroySpinner(this.scheduledOrderIndicator),n.sendSuccess(this.WIDGET_ID,this.translate("saveScheduledOrderSuccessMessage"),!0),this.isAgentApplication&&this.redirectToScheduleOrderPage(this.links().agentScheduledOrder.route)},saveScheduledOrderError:function(e){n.sendError(this.WIDGET_ID,this.translate("saveScheduledOrderErrorMessage",{result:e}),!0),this.destroySpinner(this.scheduledOrderIndicator)},deleteScheduledOrder:function(e){this.closeModalById("#cc-scheduleOrder-Modal"),this.createSpinner(this.scheduledOrderIndicator,this.scheduledOrderIndicatorOptions),this.scheduledOrder().remove(this.deleteScheduledOrderSuccess,this.deleteScheduledOrderError)},deleteScheduledOrderSuccess:function(){n.clearError(this.WIDGET_ID),n.clearSuccess(this.WIDGET_ID),n.sendSuccessToPage(this.WIDGET_ID,this.translate("deleteScheduledOrderSuccessMessage"),!0,null,!0),this.destroySpinner(this.scheduledOrderIndicator),this.redirectToScheduleOrderPage(this.links().agentScheduledOrder.route)},redirectToScheduleOrderPage:function(e){var t={};this.user().navigateToPage(e+"?customerId="+d.getInstance().getShopperProfileId())},deleteScheduledOrderError:function(e){n.clearError(this.WIDGET_ID),n.clearSuccess(this.WIDGET_ID),n.sendError(this.WIDGET_ID,this.translate("deleteScheduledOrderErrorMessage",{result:e}),!0),this.destroySpinner(this.scheduledOrderIndicator)},mergeToCart:function(e,t){var r=this;e.order?r.selectedOrder(e.order):e.scheduledOrder().templateOrder().order?r.selectedOrder(e.scheduledOrder().templateOrder().order):e.scheduledOrder().templateOrder().shoppingCart?r.selectedOrder(e.scheduledOrder().templateOrder().shoppingCart):r.orderDetailsWrapper.scheduledOrderDetails()&&r.selectedOrder(r.orderDetailsWrapper.scheduledOrderDetails().templateOrder.shoppingCart),r.cart().mergeCart(!0);var i=function(){r.isAgentApplication?r.copyOrderSuccess():r.user().validateAndRedirectPage("/cart")},s=function(e){var t="",r;for(var i=0;i<e.length;i++)t=t+"\r\n"+e[i].errorMessage;n.sendError("CartViewModel",t,!0)};r.cart().addItemsToCart(r.selectedOrder().items,i,s)},getProductData:function(e,t,s){var u=this;e[a.SHOW_INACTIVE_SKU]=!1,o.request(a.ENDPOINT_PRODUCTS_GET_PRODUCT,e,function(e){if(!e||!e.childSKUs){n.sendError(widget.WIDGET_ID,i.t("ns.searchAndAddItemsToCart:resources.productDetailsErrorText"),!0);return}e.selectedPriceListGroupId=u.site().selectedPriceListGroup().id,u.showPopup(e,t,s)},function(e){r.destroy(),n.sendError(widget.WIDGET_ID,i.t("ns.searchAndAddItemsToCart:resources.productDetailsErrorText"),!0)},t.productId)},showPopup:function(t,n,r){var i=this;if(r){var o=s(r),u=e.dataFor(o[0]),a=u.widgets()[0];i.createProductDetailstWidget(a,n,r,t)}},getSKUDetailsFailure:function(e){console.log("get sku failure")},createProductDetailstWidget:function(e,t,n,r){var i=this,o={externalPrice:t.externalPrice,quantity:t.quantity},u=s(n);x.setProductDetailsWidgetData(e,r,null,o),e.isExchangeRequest(!0),u.modal("show")},formatOrderOutcome:function(e){return e.orderId?i.t("ns.common:resources.successText"):i.t("ns.common:resources.failureText")},setShippingGroupForTracking:function(e){var t=this;t.selectedShippingGroupForTracking(e)},showAddressDetails:function(e){var t=this,n=new w("return-from-address",null,E.translateHelper,E.shippingCountryData(),E.defaultShippingCountry());n.countriesList(E.shippingCountryData()),n.copyFrom(e,E.shippingCountryData()),t.modalObject(n),t.opDynamicProperty("view"),t.populateDynamicPropertiesMetaData(n)},checkForEmptyString:function(e){var t=this;return e()?t.translate("notApplicableText"):e},populateDynamicPropertiesMetaData:function(e){var t=this;t.orderDetailsWrapper.getAddressDynamicPropertiesMetaData(t.getAddressDynamicPropertiesMetaDataSuccessCallback.bind(t),t.getAddressDynamicPropertiesMetaDataFailureCallback.bind(t)),s.when(t.dynamicPropertiesLoaded).done(function(){t.dynamicPropertyMetaInfo&&t.dynamicPropertyMetaInfo.dynamicPropertyMetaCache&&t.dynamicPropertyMetaInfo.dynamicPropertyMetaCache.contactInfo&&t.initializeDynamicProperties(t.dynamicPropertyMetaInfo.dynamicPropertyMetaCache.contactInfo,e)})},initializeDynamicProperties:function(e,t){var n=this,r=[];for(var i=0,o=0;o<e.length;o++)e[o].uiEditorType()==="checkbox"?(r[i]=e[o],r[i].value(t[e[o].id()]()),i++):t[e[o].id()]()&&(e[o].uiEditorType()===a.DISPLAY_FORMAT_TYPE_DATE_OJET||e[o].uiEditorType()===a.DISPLAY_FORMAT_TYPE_DATE?(r[i]=e[o],r[i].value(u.formatDateAndTime(t[e[o].id()](),u.DEFAULT_DATE_FORMAT,a.OJET_INPUT_SHORT_DATE_FORMAT,null))):(r[i]=e[o],r[i].value(t[e[o].id()]())),i++);n.dynamicProperties(r),s("#cc-showAddressDetailsModal").modal("show")},getLocaleTextForOriginOfOrder:function(e){var t=this;switch(e){case a.ORIGIN_PUNCHOUT:return t.translate("punchoutText");case a.ORIGIN_PURCHASE_ORDER:return t.translate("purchaseOrderText")}return""},handleAddProductToPurchaseListSuccess:function(e){var t=this;n.sendMessage(t.WIDGET_ID,t.translate("purchaseListAddSuccessMessage"),"success",!0,!0)},convertToPaymentDueInMixCurrencyFormat:function(e){var t=this,n="",r=t.currencySymbol;if(e.priceInfo.primaryCurrencyTotal>=0&&e.priceInfo.secondaryCurrencyTotal>=0){var s=e.priceInfo.primaryCurrencyTotal,o=e.priceInfo.secondaryCurrencyTotal;if(e.hasOwnProperty(a.TOTAL_AMOUNT_AUTHORIZED_MAP)){var u=e.totalAmountAuthorizedMap[e.priceInfo.currencyCode],f=e.totalAmountAuthorizedMap[e.secondaryCurrencyCode];u||(u=0);if(u>=0&&s>=u){var l=s-u;l=l.toFixed(e.priceListGroup.currency.fractionalDigits)}f||(f=0);if(f>=0&&o>=f)var c=o-f;return l>0&&(n+=i.t("ns.common:resources.symbolAndAmountText",{currencySymbol:r+" ",amount:l})),l>0&&c>0&&(n+="+"),c>0&&(n+=i.t("ns.common:resources.symbolAndAmountText",{currencySymbol:t.getSecondaryCurrency(e.secondaryCurrencyCode).symbol,amount:c})),n}}}}})