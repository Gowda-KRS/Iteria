define(["knockout","pubsub","ccLogger","notifier","ccConstants","jquery","ccRestClient","navigation","spinner","viewModels/delegatedAdminContacts"],function(e,t,n,r,i,s,o,u,a,f){"use strict";return{WIDGET_ID:"delegatedAdminContacts",interceptedLink:null,contactDetailsMode:e.observable(!1),removedContact:e.observable(!1),contactSearchValue:e.observable(""),fetchSize:e.observable(15),firstName:e.observable(null),isFirstNameModified:!1,contactId:e.observable(null),lastName:e.observable(null),isLastNameModified:!1,emailAddress:e.observable(null),isEmailAddressModified:!1,roles:e.observable(null),isRolesModified:!1,status:e.observable(!0),disableActive:e.observable(!1),inMultipleAccounts:e.observable(!1),statusTranslation:e.observable("active"),isStatusModified:!1,state:e.observable(null),isCurrentUser:e.observable(!1),delegatedAdminContactsListGrid:e.observableArray([]),punchoutUserId:e.observable(null),roleFilterText:e.observable(""),isDelegatedAdminFormEdited:!1,subscriptions:[],currentOrganizationSubscription:{},opDynamicProperty:e.observable(),sortDirections:e.observable({firstName:"both",lastName:"both",email:"both"}),listingIndicatorOptions:{parent:"#CC-delegatedAdminContactsList",posTop:"10%",posLeft:"50%"},organizationRoles:e.observableArray([]),organizationRolesFilterList:e.observableArray([]),contactRoles:e.observableArray([]),homeRoute:"",dynamicProperties:e.observableArray([]),cachedDynamicPropertySpec:{},onLoad:function(n){var o=this;n.isDelegatedAdminFormEdited=!1,n.listingViewModel=e.observable(),n.listingViewModel(new f),n.listingViewModel().fetchByRepositoryId=!0,n.listingViewModel().itemsPerPage=n.fetchSize(),n.listingViewModel().blockSize=n.fetchSize(),n.punchoutUserId(n.user().currentOrganization()?n.user().currentOrganization().punchoutUserId:null),n.firstName.extend({required:{params:!0,message:n.translate("firstNameRequired")},maxLength:{params:i.REPOSITORY_STRING_MAX_LENGTH,message:n.translate("maxlengthValidationMsg",{fieldName:n.translate("firstNameText"),maxLength:i.REPOSITORY_STRING_MAX_LENGTH})}}),n.lastName.extend({required:{params:!0,message:n.translate("lastNameRequired")},maxLength:{params:i.REPOSITORY_STRING_MAX_LENGTH,message:n.translate("maxlengthValidationMsg",{fieldName:n.translate("lastNameText"),maxLength:i.REPOSITORY_STRING_MAX_LENGTH})}}),n.emailAddress.extend({required:{params:!0,message:n.translate("emailAddressRequired")},maxLength:{params:i.REPOSITORY_STRING_MAX_LENGTH,message:n.translate("maxlengthValidationMsg",{fieldName:n.translate("emailAddressText"),maxLength:i.REPOSITORY_STRING_MAX_LENGTH})},pattern:{params:/^([\d\w-\.]+@([\d\w-]+\.)+[\w]{2,4})?$/,message:n.translate("invalidEmailAddress")}}),n.roles.extend({required:{params:!0,message:n.translate("rolesRequired")}}),n.validationModel=e.validatedObservable({firstName:n.firstName,lastName:n.lastName,emailAddress:n.emailAddress,roles:n.roles}),n.delegatedAdminContactsListGrid=e.computed(function(){var e,t,r,i,s=[],o,u,a;u=(n.listingViewModel().currentPage()-1)*n.listingViewModel().itemsPerPage,a=u+parseInt(n.listingViewModel().itemsPerPage,10),o=n.listingViewModel().data.slice(u,a);if(!o)return;e=o.length,i=parseInt(n.listingViewModel().itemsPerRow(),10),t=0,r=t+i;while(r<=e)s.push(o.slice(t,r)),t=r,r+=i;r>e&&t<e&&s.push(o.slice(t,e));if(s.length>=0){var f=s.length;for(var l=0;l<f;l++)s[l][0].roleString=n.getRoleString(s[l][0].roles)}return s},n),n.homeRoute=n.links().home.route,window.isAgentApplication&&(n.homeRoute=n.links().agentHome.route),s.Topic(t.topicNames.DELEGATED_CONTACTS_LIST_FAILED).subscribe(function(e){this.status==i.HTTP_UNAUTHORIZED_ERROR?(n.user().handleSessionExpired(),(u.isPathEqualTo(n.links().profile.route)||u.isPathEqualTo(n.links().delegatedAdminContacts.route))&&u.doLogin(u.getPath(),n.homeRoute)):(r.clearError(n.WIDGET_ID),r.clearSuccess(n.WIDGET_ID),r.sendError("delegatedAdminContacts",this.message?this.message:this.translate("ListingErrorMsg"),!0))}),window.isAgentApplication&&s.Topic(t.topicNames.PAGE_CHANGED).subscribe(n.triggerPageChangeEvent.bind(n))},toggleSwitch:function(e,t){if(!(!t.keyCode&&!t.charCode||t.keyCode!=13&&t.charCode!=13&&t.keyCode!=32&&t.charCode!=32))return this.isCurrentUser()===!1&&(this.status()?this.status(!1):this.status()||this.status(!0)),!0;if(t.keyCode==9)return!0},clickContactDetails:function(e,t){var n=this;n.resetContactData(),n.subscribeForChanges();if(e&&e[0]!==null&&e[0]!==undefined){n.contactId(e[0].repositoryId),n.firstName(e[0].firstName),n.lastName(e[0].lastName),n.emailAddress(e[0].email),n.user().emailAddress()==n.emailAddress()&&n.isCurrentUser(!0),e[0].parentOrganization!=null?e[0].secondaryOrganizationsCount>0?n.inMultipleAccounts(!0):n.inMultipleAccounts(!1):e[0].secondaryOrganizationsCount>1?n.inMultipleAccounts(!0):n.inMultipleAccounts(!1),e[0].active?n.status(!0):n.status(!1);if(e[0].roles){var r=n.contactRoles().length;for(var u=0;u<r;u++){var a=e[0].roles.length;for(var f=0;f<a;f++)if(n.contactRoles()[u]["function"]===e[0].roles[f]["function"]){n.contactRoles()[u].isRoleSelected(!0),n.roles(!0);break}}}!n.isCurrentUser()&&!n.inMultipleAccounts()?n.disableActive(!1):n.disableActive(!0),o.request(i.ENDPOINT_GET_CONTACT_BY_ORGANIZATION,null,this.getMemberSuccessFunction.bind(this),this.getMemberFailureFunction.bind(this),this.contactId())}else this.roles(!0),this.isFirstNameModified=!0,this.isLastNameModified=!0,this.isEmailAddressModified=!0,this.isRolesModified=!0,this.isStatusModified=!0,o.profileType==="agentUI"&&this.populateDynamicPropertiesForNewContact();return n.isDelegatedAdminFormEdited=!1,n.contactDetailsMode(!0),s("#cc-contact-first-name").focus(),!1},roleFilterChanged:function(e,t){var n=this,r=n.organizationRolesFilterList().length;for(var i=0;i<r;i++)n.organizationRolesFilterList()[i]["function"]===n.roleFilterText()&&(n.listingViewModel().roleValue=n.organizationRolesFilterList()[i].repositoryId);t.originalEvent&&(n.listingViewModel().itemsPerPage=n.fetchSize(),n.listingViewModel().blockSize=n.fetchSize(),n.listingViewModel().refinedFetch())},subscribeForChanges:function(){this.subscriptions.push(this.firstName.subscribe(function(e){this.isDelegatedAdminFormEdited=!0,this.isFirstNameModified=!0},this)),this.subscriptions.push(this.lastName.subscribe(function(e){this.isDelegatedAdminFormEdited=!0,this.isLastNameModified=!0},this)),this.subscriptions.push(this.emailAddress.subscribe(function(e){this.isDelegatedAdminFormEdited=!0,this.isEmailAddressModified=!0},this)),this.subscriptions.push(this.status.subscribe(function(e){this.isDelegatedAdminFormEdited=!0,this.isStatusModified=!0,this.status()?this.statusTranslation(this.translate("active")):this.statusTranslation(this.translate("inactive"))},this));var e=this.contactRoles().length;for(var t=0;t<e;t++)this.subscriptions.push(this.contactRoles()[t].isRoleSelected.subscribe(function(e){this.isDelegatedAdminFormEdited=!0,this.roles(!0),this.isRolesModified=!0},this))},searchContactDetails:function(e,t){var n=this;this.contactSearchValue()!=""&&this.contactSearchValue(this.contactSearchValue().trim()),n.listingViewModel().searchValue=this.contactSearchValue(),n.listingViewModel().refinedFetch()},beforeAppear:function(e){var t=this;if(t.user().loggedIn()==0)u.doLogin(u.getPath(),t.homeRoute);else{if(t.user().roles().length==0&&t.user().id()==""){t.user().isDelegatedAdmin(!0);return}window.isAgentApplication&&(t.currentOrganizationSubscription=t.user().currentOrganization.subscribe(function(){t.user().active()&&t.user().isDelegatedAdmin()&&t.user().currentOrganization()&&t.listingViewModel().orgValue!==t.user().currentOrganization().repositoryId&&(t.updateOrganizationRoles(t.user().organizations()[0].relativeRoles()),t.listingViewModel().orgValue=t.user().currentOrganization().repositoryId,t.listingViewModel().refinedFetch())}));if(!t.user().isDelegatedAdmin()||window.isAgentApplication&&!t.user().active())r.clearError(t.WIDGET_ID),r.clearSuccess(t.WIDGET_ID);else{t.roleFilterText(""),t.listingViewModel().clearOnLoad=!0,t.listingViewModel().orgValue=t.user().currentOrganization()?t.user().currentOrganization().repositoryId:null,t.listingViewModel().load(1,1),t.contactDetailsMode(!1),t.user().organizations()[0]?t.updateOrganizationRoles(t.user().organizations()[0].relativeRoles()):t.userOrganizationsSubscription=t.user().organizations.subscribe(function(e){e[0]&&(t.updateOrganizationRoles(e[0].relativeRoles()),t.userOrganizationsSubscription.dispose())});var n={};n[i.PARENT]=i.ENDPOINT_SHOPPER_TYPE_PARAM,t.listingViewModel&&t.listingViewModel().dynamicPropertyMetaInfo&&t.listingViewModel().dynamicPropertyMetaInfo.dynamicPropertyMetaCache&&!t.listingViewModel().dynamicPropertyMetaInfo.dynamicPropertyMetaCache.hasOwnProperty(i.ENDPOINT_SHOPPER_TYPE_PARAM)&&o.request(i.ENDPOINT_GET_ITEM_TYPE,n,this.getItemTypeSuccessFunction.bind(this),this.getItemTypeFailureFunction.bind(this),i.ENDPOINT_SHOPPER_TYPE_PARAM)}}t.opDynamicProperty("update")},saveContactData:function(e){var t=this;if(!this.validationModel.isValid()){this.validationModel.errors.showAllMessages(),r.clearError(t.WIDGET_ID),r.clearSuccess(t.WIDGET_ID),r.sendError(this.WIDGET_ID,this.translate("ErrorMsg"),!0);return}var n=this.koToJS();if(o.profileType==="agentUI"){if(!t.validateDynamicProperties())return;var s=t.getDynamicPropertyChanges(n);s&&(t.isDelegatedAdminFormEdited=!0)}t.isDelegatedAdminFormEdited?this.contactId()!==null?o.request(i.ENDPOINT_UPDATE_CONTACTS_BY_ORGANIZATION,n,this.updateMemberSuccessFunction.bind(this,e),this.updateMemberFailureFunction.bind(this),this.contactId()):o.request(i.ENDPOINT_CREATE_CONTACTS_BY_ORGANIZATION,n,this.createMemberSuccessFunction.bind(this,e),this.createMemberFailureFunction.bind(this)):this.redirectToContactListingPage(!0)},confirmRemoveContact:function(e){var t=this;this.removedContact(!0);var n={};n.members=[],n.members.push(this.contactId()),o.request(i.REMOVE_CONTACTS,n,this.updateMemberSuccessFunction.bind(this,e),this.updateMemberFailureFunction.bind(this))},createMemberSuccessFunction:function(e,t){r.sendSuccess(this.WIDGET_ID,this.translate("ContactCreationSuccessMsg"),!0),this.isDelegatedAdminFormEdited=!1,this.user().organizations()[0]&&this.user().organizations()[0].updatenumberOfActiveApprovers(),t&&t.id&&this.contactId(t.id),e==1&&this.redirectToContactListingPage(!0)},createMemberFailureFunction:function(e){var t=this;r.clearError(this.WIDGET_ID),r.clearSuccess(this.WIDGET_ID),e.status==i.HTTP_UNAUTHORIZED_ERROR?(t.user().handleSessionExpired(),u.isPathEqualTo(t.links().profile.route)&&u.doLogin(u.getPath(),t.homeRoute)):r.sendError(t.WIDGET_ID,e.message,!0)},getItemTypeSuccessFunction:function(e){e&&(this.cachedDynamicPropertySpec=e.specifications,this.listingViewModel().dynamicPropertyMetaInfo.intializeDynamicProperties(e.specifications,i.ENDPOINT_SHOPPER_TYPE_PARAM))},getItemTypeFailureFunction:function(e){var t=this;r.clearError(this.WIDGET_ID),r.clearSuccess(this.WIDGET_ID),e.status==i.HTTP_UNAUTHORIZED_ERROR?(t.user().handleSessionExpired(),u.isPathEqualTo(t.links().profile.route)&&u.doLogin(u.getPath(),t.homeRoute)):r.sendError(t.WIDGET_ID,e.message,!0)},getMemberSuccessFunction:function(t){t&&(e.mapping.fromJS(t,{},this.listingViewModel()),this.isDelegatedAdminFormEdited=!1,o.profileType==="agentUI"&&this.populateDynamicProperties(t.dynamicProperties))},getMemberFailureFunction:function(e){var t=this;r.clearError(this.WIDGET_ID),r.clearSuccess(this.WIDGET_ID),e.status==i.HTTP_UNAUTHORIZED_ERROR?(t.user().handleSessionExpired(),u.isPathEqualTo(t.links().profile.route)&&u.doLogin(u.getPath(),t.homeRoute)):r.sendError(t.WIDGET_ID,e.message,!0)},updateMemberSuccessFunction:function(e,t){var n=this;r.clearError(this.WIDGET_ID),r.clearSuccess(this.WIDGET_ID),this.removedContact()?(r.sendSuccess(this.WIDGET_ID,this.translate("contactRemovedMsg"),!0),this.removedContact(!1)):(r.sendSuccess(this.WIDGET_ID,this.translate("SuccessMsg"),!0),this.isDelegatedAdminFormEdited=!1),this.user().organizations()[0]&&this.user().organizations()[0].updatenumberOfActiveApprovers(),e==1&&this.redirectToContactListingPage(!0),window.isAgentApplication&&n.user().getCurrentUser(null,null,null,null)},updateMemberFailureFunction:function(e){var t=this;r.clearError(this.WIDGET_ID),r.clearSuccess(this.WIDGET_ID),e.status==i.HTTP_UNAUTHORIZED_ERROR?(t.user().handleSessionExpired(),u.isPathEqualTo(t.links().profile.route)&&u.doLogin(u.getPath(),t.homeRoute)):r.sendError(this.WIDGET_ID,e.message,!0)},koToJS:function(){var e=this,t={};return this.isFirstNameModified&&(t[i.FIRST_NAME_TEXT]=this.firstName()),this.isLastNameModified&&(t[i.LAST_NAME_TEXT]=this.lastName()),this.isEmailAddressModified&&(t[i.EMAIL_ADDRESS_TEXT]=this.emailAddress()),this.isStatusModified&&(t[i.ACTIVE_TEXT]=this.status()),this.contactId()||(t[i.RECEIVE_MAIL_TEXT]=i.YES_TEXT),this.isRolesModified&&(t[i.ROLES_TEXT]=e.getSelectedRoles()),t},cancelContactData:function(){this.isDelegatedAdminFormEdited?(s("#cc-cancel-contacts-ModalContainer").on("show.bs.modal",function(){s("#cc-cancel-contacts-ModalContainer-modal-dialog").show()}),s("#cc-cancel-contacts-ModalContainer").on("hide.bs.modal",function(){s("#cc-cancel-contacts-ModalContainer-modal-dialog").hide(),s("div").remove(".modal-backdrop"),s("body").removeClass("no-scroll modal-open"),s("body").addClass("modal-close")}),s("#cc-cancel-contacts-ModalContainer").modal("show")):this.redirectToContactListingPage(!0)},cancelRemoveContact:function(){this.redirectToContactListingPage(!0)},removeContactData:function(){s("#cc-remove-contact-ModalContainer").on("show.bs.modal",function(){s("#cc-remove-contact-ModalContainer-modal-dialog").show()}),s("#cc-remove-contact-ModalContainer").on("hide.bs.modal",function(){s("#cc-remove-contact-ModalContainer-modal-dialog").hide(),s("div").remove(".modal-backdrop"),s("body").removeClass("no-scroll modal-open"),s("body").addClass("modal-close")}),s("#cc-remove-contact-ModalContainer").modal("show")},populateDynamicProperties:function(e){var t=e;this.dynamicProperties([]);var n=this.listingViewModel().dynamicPropertyMetaInfo.dynamicPropertyMetaCache[i.ENDPOINT_SHOPPER_TYPE_PARAM],r=[],o,u;for(var a=0;a<n.length;++a){var f=n[a].id();u=s.extend(!0,{},n[a]);for(var l=0;l<t.length;++l)if(f===t[l].id){o=t[l].value,u.value(o),r.push(u);break}}this.dynamicProperties(this.dynamicProperties().concat(r))},populateDynamicPropertiesForNewContact:function(){this.cachedDynamicPropertySpec&&this.listingViewModel().dynamicPropertyMetaInfo.intializeDynamicProperties(this.cachedDynamicPropertySpec,i.ENDPOINT_SHOPPER_TYPE_PARAM),this.dynamicProperties([]);var e=this.listingViewModel().dynamicPropertyMetaInfo.dynamicPropertyMetaCache[i.ENDPOINT_SHOPPER_TYPE_PARAM];this.dynamicProperties(this.dynamicProperties().concat(e))},validateDynamicProperties:function(){var e=this.dynamicProperties();for(var t=0;t<e.length;++t)if(!e[t].value.isValid())return!1;return!0},getDynamicPropertyChanges:function(e){var t=this.dynamicProperties(),n,r=!1;for(var i=0;i<t.length;++i)n=t[i],n.value.isModified&&n.value.isModified()&&(e[n.id()]=n.value(),r=!0);return r},searchContactKeyPress:function(e,t){var n=this;try{return t.which==13?(n.searchContactDetails(),!1):!0}catch(r){}},handleModalUpdate:function(){var e=this.saveContactData(!0);s("#cc-cancel-contacts-ModalContainer").modal("hide"),s("body").removeClass("modal-open"),s(".modal-backdrop").remove()},handleModalCancelUpdateDiscard:function(){var e=this;e.redirectToContactListingPage(!0)},redirectToContactListingPage:function(e){e&&(this.contactSearchValue()!=""&&this.contactSearchValue(this.contactSearchValue().trim()),this.listingViewModel().searchValue=this.contactSearchValue(),this.interceptedLink=="/cart"&&(this.interceptedLink="/delegatedAdminContacts"),(this.interceptedLink==null||this.interceptedLink==undefined||this.interceptedLink==""||this.interceptedLink=="/delegatedAdminContacts")&&this.listingViewModel().refinedFetch()),this.user().isSearchInitiatedWithUnsavedChanges(!1),this.interceptedLink!=null&&this.interceptedLink!=undefined&&this.interceptedLink!=""&&!u.isPathEqualTo(this.interceptedLink)?(this.isDelegatedAdminFormEdited=!1,u.goTo(this.interceptedLink)):this.contactDetailsMode(!1),this.isDelegatedAdminFormEdited=!1,s("#cc-cancel-contacts-ModalContainer").modal("hide"),s("body").removeClass("modal-open"),s(".modal-backdrop").remove(),r.clearError(this.WIDGET_ID)},clickContactSort:function(e,t){var n=this;n.sortDirections()[t]=e,t=="firstName"?(n.sortDirections().lastName="both",n.sortDirections().email="both"):t=="lastName"?(n.sortDirections().firstName="both",n.sortDirections().email="both"):t=="email"&&(n.sortDirections().lastName="both",n.sortDirections().firstName="both"),n.sortDirections.valueHasMutated();var r=t+":"+e;n.listingViewModel().sortProperty=r,n.listingViewModel().refinedFetch()},resetContactData:function(){this.firstName(null),this.interceptedLink=null,this.lastName(null),this.emailAddress(null),this.isDelegatedAdminFormEdited=!1,this.roles(null),this.status(!0),this.state(null),this.contactId(null),this.isCurrentUser(!1),this.isFirstNameModified=!1,this.isLastNameModified=!1,this.isEmailAddressModified=!1,this.isStatusModified=!1,this.isRolesModified=!1,this.statusTranslation(this.translate("active")),this.validationModel.errors.showAllMessages(!1),this.resetContactRoles();var e=this.subscriptions.length;for(var t=0;t<e;t++)this.subscriptions[t].dispose()},updateOrganizationRoles:function(t){var n=this,r=[];n.organizationRoles([]),n.organizationRolesFilterList([]),r.push({"function":"",displayText:e.observable(n.translate("allOption")),repositoryId:""}),t=t.sort(n.sortByProperty(i.ROLES_TEXT_PROPERTY));var s=t.length;for(var o=0;o<s;o++){var u={};u["function"]=t[o]["function"],u.displayText=e.observable(n.translate(t[o]["function"]+"Text")),u.repositoryId=t[o].repositoryId,u.relativeTo=t[o].relativeTo,n.organizationRoles.push(u),u["function"]!=="buyer"&&r.push(u)}n.organizationRolesFilterList(r)},getRoleString:function(e){var t=this,n="";e=e.sort(t.sortByProperty(i.ROLES_TEXT_PROPERTY));var r=e.length;for(var s=0;s<r;s++)n=n+t.translate(e[s]["function"]+"Text")+", ";return n=n.substring(0,n.length-2),n},resetContactRoles:function(){var t=this;t.contactRoles([]);var n=t.organizationRoles().length;for(var r=0;r<n;r++){var i={};i["function"]=t.organizationRoles()[r]["function"],i.displayText=t.organizationRoles()[r].displayText,i.relativeTo=t.organizationRoles()[r].relativeTo,t.organizationRoles()[r]["function"]==="buyer"?i.isRoleSelected=e.observable(!0):i.isRoleSelected=e.observable(!1),t.contactRoles.push(i)}},getSelectedRoles:function(){var e=this,t=[],n=e.contactRoles().length;for(var r=0;r<n;r++){var i={};if(e.contactRoles()[r].isRoleSelected()){i["function"]=e.contactRoles()[r]["function"];var s={};s.id=e.user().currentOrganization().id?e.user().currentOrganization().id:e.user().currentOrganization().repositoryId,i.relativeTo=s,t.push(i)}}return t},sortByProperty:function(e){var t=1;return e[0]==="-"&&(t=-1,e=e.substr(1)),function(n,r){var i=n[e]<r[e]?-1:n[e]>r[e]?1:0;return i*t}},triggerPageChangeEvent:function(){var e=this,t=e.subscriptions.length;for(var n=0;n<t;n++)e.subscriptions[n].dispose();e.currentOrganizationSubscription&&e.currentOrganizationSubscription.dispose&&e.currentOrganizationSubscription.dispose(),e.userOrganizationsSubscription&&e.userOrganizationsSubscription.dispose&&e.userOrganizationsSubscription.dispose()}}})