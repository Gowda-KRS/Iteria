define(["knockout","ccRestClient","jquery","CCi18n","ccConstants","notifier","pubsub","pageLayout/organization","viewModels/site-listing","spinner","agentViewModels/agentConfiguration","agentViewModels/account-site-selector","viewModels/dynamicPropertyMetaContainer"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){"use strict";return{WIDGET_ID:"agentAccountDetails",SELF_REGISTRATION_SOURCE:"selfRegistration",isSelfRegistrationEnabled:e.observable(!1),delegatedAdminAllowedThroughAgent:e.observable(!1),opDynamicProperty:e.observable(),allowedAccountCustomerTypes:e.observableArray(),allowedAccountTypes:e.observableArray(),isPrincipalAccount:e.observable(!1),accountParentOrganizationId:e.observable(),showInheritedCheckbox:e.observable(!1),isOrgSourceSelfRegistration:e.observable(!1),orgRegistrationApproverComments:e.observable(),orgRegistrationRequesterComments:e.observable(),requesterAccountName:e.observable(),registrationRequestOriginSiteInfo:e.observable(),approvalRequired:e.observable(),isWebhookEnabled:e.observable(),approvalErrorMessage:e.observable(),accountDetailsIndicator:"#cc-agent-account-details-container",accountDetailsIndicatorOptions:{parent:"#cc-agent-account-details-container",posTop:"50%",posLeft:"50%"},resourcesLoaded:function(e){e.componentPlaceholder=e.translate("noneDefinedText"),e.propertyDropdownSelectText=e.translate("propertySelectText")},onLoad:function(t){t.agentConfigurationData=l.getConfigurationProperty(i.AGENT_CONFIGURATIONS),t.delegatedAdminAllowedThroughAgent=t.agentConfigurationData?t.agentConfigurationData.delegatedAdminAllowedThroughAgent:!1,t.setRegistrationEnabledFlag(),t.initializeLocalVariables(),t.accountAndSiteSelector=c,t.enableApprovalProperties=e.pureComputed(function(){t.updateApprovalInfoPopover();var e=t.user();return e.isDelegatedAdmin()&&e.currentOrganizationDetails()&&e.currentOrganizationDetails().delegateApprovalManagement()&&e.currentOrganizationDetails().numberOfActiveApprovers()>0&&!t.isWebhookEnabled()&&e.active()&&t.delegatedAdminAllowedThroughAgent},t);var n=t.user().priceListGroup.currency.fractionalDigits();t.orderPriceLimit=e.observable().extend({numeric:n}),t.orderPriceLimit.extend({pattern:{message:r.t("ns.common:resources.quantityNumericMsg"),params:/^-?[0-9]+([.][0-9]+)?$/g},maxLength:{params:i.MAX_LENGTH_PURCHASE_LIMIT,message:r.t("ns.common:resources.maxlengthValidationMsg",{maxLength:i.MAX_LENGTH_PURCHASE_LIMIT})},validation:{validator:function(e,t){return e>=t},message:t.translate("priceInvalidSummaryText")+t.translate("priceValidation"),params:0}}),t.user().currentOrganizationDetails()&&t.setAccountDetails(),t.user().currentOrganizationDetails.subscribe(t.setAccountDetails.bind(t))},beforeAppear:function(e){var t=this},setAccountDetails:function(){var e=this,t=e.user().currentOrganizationDetails();t.parentOrganization&&t.parentOrganization.id()?(e.isPrincipalAccount(!1),e.accountParentOrganizationId(t.parentOrganization.id())):(e.isPrincipalAccount(!0),e.accountParentOrganizationId(null)),e.showInheritedCheckbox(!e.isPrincipalAccount()&&e.accountParentOrganizationId()),e.isOrgSourceSelfRegistration(e.SELF_REGISTRATION_SOURCE===t.source()),e.isOrgSourceSelfRegistration()&&e.getOrganizationRequestDetails(),e.approvalRequired(t.approvalRequired()),e.orderPriceLimit(t.orderPriceLimit()),e.isWebhookEnabled(t.isApprovalWebhookEnabled()),e.setOpDynamicProperty(),e.user().currentOrganizationDetails().updateDynamicProperties(e.opDynamicProperty()),e.destroySpinner()},setRegistrationEnabledFlag:function(){var e=this,n={};t.request(i.ENDPOINT_SETTINGS_GET_POLICIES,n,function(t){var n=t.selfRegistrationEnabled;n?e.isSelfRegistrationEnabled(n):u.prototype.loadOrganizationsWithSelfRegistration(e.getListOrganizationsSuccess.bind(e),e.getListOrganizationsFailure.bind(e))},function(t){s.sendError(e.WIDGET_ID,t.message,!0)})},getListOrganizationsSuccess:function(e){var t=this;t.isSelfRegistrationEnabled(e&&e.totalResults>0?!0:!1)},getListOrganizationsFailure:function(e){var t=this;t.isSelfRegistrationEnabled(!1),s.sendError(t.WIDGET_ID,e.message,!0)},handleCancelUpdate:function(){var e=this;e.createSpinner(),e.approvalRequired(e.user().currentOrganizationDetails().approvalRequired()),e.orderPriceLimit(e.user().currentOrganizationDetails().orderPriceLimit()),e.isWebhookEnabled(e.user().currentOrganizationDetails().isApprovalWebhookEnabled());if(e.user().currentOrganizationDetails().dynamicProperties()&&e.user().currentOrganizationDetails().dynamicProperties().length>0){var t=e.user().currentOrganizationDetails().dynamicProperties();for(var n=0;n<t.length;n++)t[n].value.isModified()&&e.user().currentOrganizationDetails().dynamicProperties()[n].value(null)}e.user().currentOrganizationDetails().updateDynamicProperties(e.opDynamicProperty()),e.user().currentOrganizationDetails().resetDynamicPropertiesValueIsModified(),e.destroySpinner()},updateAccountDetails:function(){var e=this,t={};e.validate()&&(e.createSpinner(),e.unwrap(t),e.user().currentOrganizationDetails().updateOrganization(t,e.updateAccountDetailsSuccess.bind(e),e.updateAccountDetailsFailure.bind(e)))},updateAccountDetailsSuccess:function(e){var t=this;s.sendSuccess(t.WIDGET_ID,t.translate("accountUpdateSuccessMessage"),!0),t.user().currentOrganizationDetails().populateOrganizationViewModel(e),t.user().currentOrganizationDetails().resetDynamicPropertiesValueIsModified(),t.user().currentOrganizationDetails().updateDynamicProperties(t.opDynamicProperty()),t.destroySpinner()},updateAccountDetailsFailure:function(e){var t=this;s.sendError(t.WIDGET_ID,e.message,!0),t.destroySpinner()},validate:function(){var e=this;return e.orderPriceLimit.isValid()?e.user().currentOrganizationDetails().isOrganizationDynamicPropertiesValid():(n("#purchaseOrderLimitField").focus(),!1)},createSpinner:function(){var e=this;f.create(e.accountDetailsIndicatorOptions)},destroySpinner:function(){var e=this;f.destroyWithoutDelay(e.accountDetailsIndicator)},unwrap:function(e){var t=this,n=t.user().currentOrganizationDetails().dynamicProperties();for(var r=0;r<n.length;r++)n[r].value.isModified&&n[r].value.isModified()&&(e[n[r].id()]=n[r].value());t.user().currentOrganizationDetails().delegateApprovalManagement()&&(e[i.APPROVAL_REQUIRED]=this.approvalRequired(),e[i.ORDER_PRICE_LIMIT]=this.orderPriceLimit())},setOpDynamicProperty:function(){var e=this;!e.user().active()||!e.user().isDelegatedAdmin()||!e.delegatedAdminAllowedThroughAgent?e.opDynamicProperty(i.DYNAMIC_PROPERTY_VIEW_ONLY):e.opDynamicProperty(i.DYNAMIC_PROPERTY_UPDATE_ONLY)},initializeLocalVariables:function(){var e=this;e.allowedAccountCustomerTypes([{value:i.CUSTOMER_TYPES_STANDARD_ID,label:e.translate("standardText")},{value:i.CUSTOMER_TYPES_PREFERRED_ID,label:e.translate("preferredText")},{value:i.CUSTOMER_TYPES_ENTERPRISE_ID,label:e.translate("enterpriseText")},{value:i.CUSTOMER_TYPES_OEM_ID,label:e.translate("oemText")},{value:i.CUSTOMER_TYPES_DISTRIBUTOR_ID,label:e.translate("distributorText")},{value:i.CUSTOMER_TYPES_SUPPLIER_ID,label:e.translate("supplierText")}]),e.allowedAccountTypes([{value:i.ACCOUNT_TYPES_COMPANY_ID,label:e.translate("companyText")},{value:i.ACCOUNT_TYPES_DIVISION_ID,label:e.translate("divisionText")},{value:i.ACCOUNT_TYPES_DEPARTMENT_ID,label:e.translate("departmentText")},{value:i.ACCOUNT_TYPES_GROUP_ID,label:e.translate("groupText")}])},getOrganizationRequestDetails:function(){var e=this,t=function(t){if(t&&t.items&&t.items.length){var n=t.items[0].id;e.user().currentOrganizationDetails().getRegistrationRequestNotes(n,e.getOrganizationRequestDetailsSuccess.bind(e),e.getOrganizationRequestDetailsFailure.bind(e))}},n=function(t){s.sendError(e.widget.WIDGET_ID,t.message,!0)};e.user().currentOrganizationDetails().getRegistrationRequest(t,n)},getOrganizationRequestDetailsSuccess:function(e){var t=this;if(e){t.orgRegistrationApproverComments(e[i.REGISTRATION_REQUEST_APPROVER_COMMENTS]),t.orgRegistrationRequesterComments(e[i.REGISTRATION_REQUEST_REQUESTER_COMMENTS]),t.requesterAccountName(e[i.REGISTRATION_REQUEST_REQUESTER_ORG_NAME]);var n=e[i.REGISTRATION_REQUEST_ORIGIN_SITE_ID];t.updateRegistrationSiteInfo(n)}},getOrganizationRequestDetailsFailure:function(e){s.sendError(widget.WIDGET_ID,e.message,!0)},updateRegistrationSiteInfo:function(e){var t=this,n=a.activeSites();for(var r=0;r<n.length;r++)if(n[r].id===e){var i=n[r].name?n[r].name:n[r].id,s=n[r].productionURL?"-"+n[r].productionURL:"";t.registrationRequestOriginSiteInfo(i+s);break}t.registrationRequestOriginSiteInfo()||t.registrationRequestOriginSiteInfo(e)},updateApprovalInfoPopover:function(){var e=this;e.approvalErrorMessage(null),e.delegatedAdminAllowedThroughAgent?e.user().active?e.user().isDelegatedAdmin()?e.isWebhookEnabled()?e.approvalErrorMessage(e.translate("approvalWebhookIsEnabled")):e.user().currentOrganizationDetails()&&!e.user().currentOrganizationDetails().delegateApprovalManagement()?e.approvalErrorMessage(e.translate("delegatedAdminDisabledAccountSettingsText")):e.user().currentOrganizationDetails()&&e.user().currentOrganizationDetails().numberOfActiveApprovers()===0&&e.approvalErrorMessage(e.translate("noApproverForTheOrganizationText")):e.approvalErrorMessage(e.translate("notADelegatedAdminText")):e.approvalErrorMessage(e.translate("profileInactiveText")):e.approvalErrorMessage(e.translate("delegatedAdminAllowedThroughAgentText"))}}})